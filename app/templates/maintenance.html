<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Maintenance Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <style>
    .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
    .modal.hidden { visibility: hidden; opacity: 0; }
    .modal:not(.hidden) { visibility: visible; opacity: 1; }
    .dark .modal-content { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5), 0 10px 10px -5px rgba(0,0,0,0.2); }
    .date-filter-btn.active { background-color: #3b82f6; color: white; }
    .dark .date-filter-btn.active { background-color: #60a5fa; }
    .view-detail-label { font-weight: 500; color: #4b5563; }
    .dark .view-detail-label { color: #d1d5db; }
    .view-detail-value { color: #1f2937; }
    .dark .view-detail-value { color: #f9fafb; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white">
<div class="flex flex-col md:flex-row h-screen overflow-hidden">
    <!-- Sidebar (Left) -->
    <aside class="w-64 bg-white dark:bg-gray-800 p-4 space-y-6 shadow-md hidden md:block flex-shrink-0">
      <div class="text-xl font-bold flex items-center space-x-2">
        <i data-lucide="menu" class="w-5 h-5"></i><span>Menu</span>
      </div>
      <ul class="space-y-2">
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i><a href="#">Dashboard</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="bar-chart-3" class="w-5 h-5"></i><a href="#">Analytics</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="car" class="w-5 h-5"></i><a href="#">Vehicles</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="user" class="w-5 h-5"></i><a href="#">Drivers</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="droplet" class="w-5 h-5"></i><a href="#">Fuel</a>
        </li>
        <li class="flex items-center space-x-3 text-blue-600 dark:text-blue-400 font-semibold bg-blue-50 dark:bg-gray-700 p-2 rounded-md transition-colors" id="maintenance-nav-link">
          <i data-lucide="tool" class="w-5 h-5"></i><a href="#maintenance-section">Maintenance</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="route" class="w-5 h-5"></i><a href="#">Trip</a>
        </li>
      </ul>
    </aside>
    
  <!-- Main content -->
  <main class="flex-1 overflow-auto p-6">
    <!-- Maintenance Table Section -->
    <section id="maintenance-section" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow mb-6">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
        <h2 class="text-2xl font-semibold text-gray-800 dark:text-white mb-2 sm:mb-0">Maintenance Records</h2>
        <div class="flex flex-wrap gap-2 items-center">
          <button onclick="openAddMaintenanceModal()" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-1 text-sm shadow-sm">
            <i data-lucide="plus" class="w-4 h-4"></i> Add Maintenance
          </button>
          <input type="text" id="maintenanceSearch" placeholder="Search maintenance..." class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm text-black dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div class="flex flex-wrap gap-2 items-center">
          <button onclick="exportMaintenancesExcel()" class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 text-sm shadow-sm">ðŸ“„ Excel</button>
          <button onclick="exportMaintenancesPDF()" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm shadow-sm">ðŸ§¾ PDF</button>
        </div>
      </div>

      <div class="mb-4 flex flex-wrap items-center gap-2">
        <span class="text-sm font-medium mr-2">Filter Maintenance by Date:</span>
        <button id="maintenance-filter-today" onclick="applyMaintenanceDateFilter('today')" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Today</button>
        <button id="maintenance-filter-last7" onclick="applyMaintenanceDateFilter('last7days')" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Last 7 Days</button>
        <button id="maintenance-filter-last30" onclick="applyMaintenanceDateFilter('last30days')" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Last 30 Days</button>
        <button id="maintenance-filter-all" onclick="applyMaintenanceDateFilter('all')" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 active">All Time</button>
        <button id="maintenance-filter-custom-btn" onclick="toggleMaintenanceCustomDateRange()" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Custom Range</button>
      </div>
      <div id="maintenanceCustomDateRange" class="mb-4 hidden items-center gap-2 p-3 border dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-800/50">
        <input type="date" id="maintenanceCustomStartDate" class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
        <span class="text-sm">to</span>
        <input type="date" id="maintenanceCustomEndDate" class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
        <button onclick="applyMaintenanceCustomDateFilter()" class="bg-blue-500 text-white px-3 py-1.5 text-sm rounded-md hover:bg-blue-600">Apply</button>
      </div>

      <div class="overflow-x-auto">
        <table id="maintenancesTable" class="w-full text-left text-sm">
          <thead>
            <tr class="border-b dark:border-gray-700">
              <th class="py-3 px-2 font-semibold">ID</th>
              <th class="px-2 font-semibold">Category</th>
              <th class="px-2 font-semibold">Vehicle</th>
              <th class="px-2 font-semibold">Cost</th>
              <th class="px-2 font-semibold">Receipt</th>
              <th class="px-2 font-semibold">Garage</th>
              <th class="px-2 font-semibold">Maintenance Date</th>
              <th class="px-2 font-semibold text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="maintenancesBody"></tbody>
        </table>
      </div>
      <div class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
        <div class="text-sm text-gray-600 dark:text-gray-400" id="maintenancesCount"></div>
        <div class="flex items-center space-x-1" id="maintenancesPagination"></div>
      </div>
    </section>
  </main>

    <!-- Right Sidebar -->
    <aside class="w-1/5 bg-white dark:bg-gray-800 p-4 space-y-6 shadow-md hidden lg:block flex-shrink-0">
        <div class="flex justify-between items-center">
        <button id="theme-toggle" class="text-xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">ðŸŒ™</button>
        <div><div class="text-sm font-semibold">John Doe</div><div class="text-xs text-gray-500 dark:text-gray-300">Admin</div></div>
        </div>
        <div><h4 class="font-bold mb-4 text-lg">Recent Updates</h4><div class="flex flex-col space-y-6 relative"><div class="absolute left-5 top-0 bottom-0 w-0.5 bg-blue-500"></div><div class="flex items-start space-x-4 relative"><div class="w-3 h-3 bg-blue-500 rounded-full z-10 mt-1.5 ml-4"></div><div class="ml-2"><p class="font-medium">New maintenance logged</p><p class="text-sm text-gray-500 dark:text-gray-400">1 minute ago</p></div></div><div class="flex items-start space-x-4 relative"><div class="w-3 h-3 bg-blue-500 rounded-full z-10 mt-1.5 ml-4"></div><div class="ml-2"><p class="font-medium">Vehicle status updated</p><p class="text-sm text-gray-500 dark:text-gray-400">5 minutes ago</p></div></div></div></div>
        <div class="mt-8"><h4 class="font-bold mb-4 text-lg">Quick Actions</h4><div class="grid grid-cols-2 gap-2"><button class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg flex flex-col items-center hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="file-plus-2" class="w-5 h-5 mb-1"></i><span class="text-xs">New Report</span></button><button class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg flex flex-col items-center hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="sliders-horizontal" class="w-5 h-5 mb-1"></i><span class="text-xs">Filters</span></button><button class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg flex flex-col items-center hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="help-circle" class="w-5 h-5 mb-1"></i><span class="text-xs">Help</span></button><button class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg flex flex-col items-center hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="log-out" class="w-5 h-5 mb-1"></i><span class="text-xs">Logout</span></button></div></div>
    </aside>
</div>


<!-- Add/Edit Maintenance Modal -->
<div id="addMaintenanceModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="maintenanceModalTitle">Add New Maintenance</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400">Fill in the maintenance details below</p>
        </div>
        <button onclick="closeAddMaintenanceModal()" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <form id="addMaintenanceForm" class="space-y-4">
        <input type="hidden" id="maintenanceId_form"> 
        <div>
          <label for="cat_maintenance_id_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Maintenance Category</label>
          <select id="cat_maintenance_id_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
            <option value="">Select Category</option>
          </select>
        </div>
        <div>
          <label for="vehicle_id_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Vehicle</label>
          <select id="vehicle_id_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
            <option value="">Select Vehicle</option>
          </select>
        </div>
        <div>
          <label for="maintenance_cost_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Maintenance Cost</label>
          <input type="number" step="0.01" id="maintenance_cost_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="0.00">
        </div>
        <div>
          <label for="maintenance_receipt_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Receipt (e.g., URL or Ref#)</label>
          <input type="text" id="maintenance_receipt_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="Receipt details or link">
        </div>
        <div>
          <label for="maintenance_garage_id_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Garage</label>
          <select id="maintenance_garage_id_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
             <option value="">Select Garage</option>
          </select>
        </div>
        <div>
          <label for="maintenance_date_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Maintenance Date</label>
          <input type="date" id="maintenance_date_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeAddMaintenanceModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
          <button type="submit" id="maintenanceSubmitButton" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
            <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Maintenance
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- View Maintenance Record Modal -->
<div id="viewMaintenanceModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white">Maintenance Record Details</h3>
        <button onclick="closeViewMaintenanceModal()" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <div id="viewMaintenanceDetails" class="space-y-3 text-sm">
        <div class="grid grid-cols-3 gap-x-4"><span class="view-detail-label col-span-1">Record ID:</span><span id="view-maintenance-id" class="view-detail-value col-span-2"></span></div>
        <div class="grid grid-cols-3 gap-x-4"><span class="view-detail-label col-span-1">Category:</span><span id="view-maintenance-category" class="view-detail-value col-span-2"></span></div>
        <div class="grid grid-cols-3 gap-x-4"><span class="view-detail-label col-span-1">Vehicle:</span><span id="view-maintenance-vehicle" class="view-detail-value col-span-2"></span></div>
        <div class="grid grid-cols-3 gap-x-4"><span class="view-detail-label col-span-1">Cost:</span><span id="view-maintenance-cost" class="view-detail-value col-span-2"></span></div>
        <div class="grid grid-cols-3 gap-x-4"><span class="view-detail-label col-span-1">Receipt:</span><span id="view-maintenance-receipt" class="view-detail-value col-span-2 break-all"></span></div>
        <div class="grid grid-cols-3 gap-x-4"><span class="view-detail-label col-span-1">Garage:</span><span id="view-maintenance-garage" class="view-detail-value col-span-2"></span></div>
        <div class="grid grid-cols-3 gap-x-4"><span class="view-detail-label col-span-1">Maintenance Date:</span><span id="view-maintenance-maintenance_date" class="view-detail-value col-span-2"></span></div>
        <div class="grid grid-cols-3 gap-x-4"><span class="view-detail-label col-span-1">Created At:</span><span id="view-maintenance-created_at" class="view-detail-value col-span-2"></span></div>
      </div>
      <div class="flex justify-end pt-6">
          <button type="button" onclick="closeViewMaintenanceModal()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal for Maintenance Deletion -->
<div id="confirmDeleteMaintenanceModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <div><h3 class="text-xl font-bold text-gray-800 dark:text-white">Confirm Deletion</h3><p class="text-sm text-gray-500 dark:text-gray-400">Are you sure you want to delete this maintenance record?</p></div>
        <button onclick="closeConfirmDeleteMaintenanceModal()" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i></button>
      </div>
      <div class="flex justify-end gap-3 pt-4">
        <button onclick="closeConfirmDeleteMaintenanceModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
        <button id="confirmDeleteMaintenanceBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg flex items-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i> Delete</button>
      </div>
    </div>
  </div>
</div>


<script>
  // --- Global Variables for Maintenance ---
  let allMaintenances = []; const maintenancesPerPage = 5; let currentMaintenancePage = 1;
  let maintenanceToEditId = null; let maintenanceToDeleteId = null;
  let activeMaintenanceDateFilter = 'all'; let customMaintenanceFilterStartDate = null; let customMaintenanceFilterEndDate = null;

  // Mock data (Garages is shared, others specific to Maintenance)
  const mockGarages = [{id:1, name:"Main St Auto"}, {id:2, name:"Downtown Repair"}, {id:3, name:"Speedy Lube"}, {id:4, name:"Pro Mechanics"}]; 
  const mockMaintenanceCategories = [
      {id:1, name:"Oil Change"}, {id:2, name:"Tire Rotation"},
      {id:3, name:"Brake Pad Replacement"}, {id:4, name:"Air Filter Change"}, {id:5, name:"Battery Check"}
  ];
  const mockVehicles = [ 
      {id:1, name:"Toyota Camry (ABC-123)"}, {id:2, name:"Ford F-150 (XYZ-789)"},
      {id:3, name:"Honda Civic (DEF-456)"}, {id:4, name:"Tesla Model 3 (GHI-012)"}
  ];


  // --- DOMContentLoaded ---
  document.addEventListener('DOMContentLoaded', () => {
      initializeMaintenanceSection(); 
      lucide.createIcons(); 
      const themeToggleButton = document.getElementById('theme-toggle');
      if (themeToggleButton) themeToggleButton.addEventListener('click', () => document.documentElement.classList.toggle('dark'));
      
      // Maintenance Modal close listeners
      document.getElementById('addMaintenanceModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeAddMaintenanceModal(); });
      document.getElementById('viewMaintenanceModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeViewMaintenanceModal(); });
      document.getElementById('confirmDeleteMaintenanceModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeConfirmDeleteMaintenanceModal(); });

      // Highlight active sidebar link
      const currentHash = window.location.hash || "#maintenance-section"; // Default to maintenance
      updateActiveNavLink(currentHash);
      window.addEventListener('hashchange', () => updateActiveNavLink(window.location.hash));
  });

  function updateActiveNavLink(hash) {
      document.querySelectorAll('aside ul li').forEach(li => {
          li.classList.remove('text-blue-600', 'dark:text-blue-400', 'font-semibold', 'bg-blue-50', 'dark:bg-gray-700');
          li.classList.add('text-gray-700', 'dark:text-gray-300');
      });
      const activeLink = document.querySelector(`aside ul li a[href="${hash}"]`);
      if (activeLink && activeLink.parentElement) {
          activeLink.parentElement.classList.add('text-blue-600', 'dark:text-blue-400', 'font-semibold', 'bg-blue-50', 'dark:bg-gray-700');
          activeLink.parentElement.classList.remove('text-gray-700', 'dark:text-gray-300');
      } else if (hash === "#maintenance-section" || hash === "") { // Default to maintenance
          const maintenanceNavLink = document.getElementById('maintenance-nav-link');
          if (maintenanceNavLink) {
            maintenanceNavLink.classList.add('text-blue-600', 'dark:text-blue-400', 'font-semibold', 'bg-blue-50', 'dark:bg-gray-700');
            maintenanceNavLink.classList.remove('text-gray-700', 'dark:text-gray-300');
          }
      }
  }

  // --- Date Helper Functions (Generic) ---
  function getISODateString(date) { return date.toISOString().split('T')[0]; }
  function getDateRange(filterType) {
    const today=new Date(); today.setHours(0,0,0,0); let sD=new Date(today); let eD=new Date(today); eD.setHours(23,59,59,999);
    switch(filterType){ case 'today':break; case 'last7days':sD.setDate(today.getDate()-6);break; case 'last30days':sD.setDate(today.getDate()-29);break; case 'all':return{startDate:null,endDate:null}; default:return{startDate:null,endDate:null};}
    return{startDate:getISODateString(sD),endDate:getISODateString(eD)};
  }

  // --- Maintenance Section ---
  function initializeMaintenanceSection() {
    fetchMaintenances(); 
    populateMaintenanceDropdowns();
    document.getElementById('maintenanceSearch').addEventListener('input', () => { currentMaintenancePage = 1; renderMaintenancesTable(); });
    document.getElementById('addMaintenanceForm').addEventListener('submit', handleMaintenanceFormSubmit);
    document.getElementById('confirmDeleteMaintenanceBtn').addEventListener('click', confirmDeleteMaintenance);
    setActiveMaintenanceDateFilterButton('all');
  }

  function applyMaintenanceDateFilter(filterType) {
    activeMaintenanceDateFilter = filterType; customMaintenanceFilterStartDate = null; customMaintenanceFilterEndDate = null;
    document.getElementById('maintenanceCustomDateRange').classList.add('hidden');
    setActiveMaintenanceDateFilterButton(filterType); currentMaintenancePage = 1; renderMaintenancesTable();
  }

  function toggleMaintenanceCustomDateRange() {
    document.getElementById('maintenanceCustomDateRange').classList.toggle('hidden');
    if (!document.getElementById('maintenanceCustomDateRange').classList.contains('hidden')) {
        setActiveMaintenanceDateFilterButton('maintenance-filter-custom-btn');
    } else if (activeMaintenanceDateFilter === 'custom') { // If custom range was active and is now hidden
        applyMaintenanceDateFilter('all'); // Revert to 'all'
    }
  }

  function applyMaintenanceCustomDateFilter() {
    const startDate = document.getElementById('maintenanceCustomStartDate').value;
    const endDate = document.getElementById('maintenanceCustomEndDate').value;
    if (!startDate || !endDate) { alert("Please select both start and end dates for Maintenance custom filter."); return; }
    if (new Date(startDate) > new Date(endDate)) { alert("Start date cannot be after end date for Maintenance custom filter."); return; }
    activeMaintenanceDateFilter = 'custom'; 
    customMaintenanceFilterStartDate = startDate; 
    customMaintenanceFilterEndDate = endDate;
    setActiveMaintenanceDateFilterButton('maintenance-filter-custom-btn'); 
    currentMaintenancePage = 1; 
    renderMaintenancesTable();
  }

  function setActiveMaintenanceDateFilterButton(filterId) {
    document.querySelectorAll('#maintenance-section .date-filter-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById(filterId.startsWith('maintenance-filter-') ? filterId : `maintenance-filter-${filterId}`);
    if (activeBtn) activeBtn.classList.add('active');
  }

  async function populateMaintenanceDropdowns() {
    const categorySelect = document.getElementById('cat_maintenance_id_form');
    categorySelect.innerHTML = '<option value="">Select Category</option>';
    mockMaintenanceCategories.forEach(cat => { 
      const option = document.createElement('option'); 
      option.value = cat.id; 
      option.textContent = cat.name; 
      categorySelect.appendChild(option); 
    });

    const vehicleSelect = document.getElementById('vehicle_id_form');
    vehicleSelect.innerHTML = '<option value="">Select Vehicle</option>';
    mockVehicles.forEach(v => { 
      const option = document.createElement('option'); 
      option.value = v.id; 
      option.textContent = v.name; 
      vehicleSelect.appendChild(option); 
    });
    
    const garageSelect = document.getElementById('maintenance_garage_id_form');
    garageSelect.innerHTML = '<option value="">Select Garage</option>';
    mockGarages.forEach(g => { 
      const option = document.createElement('option'); 
      option.value = g.id; 
      option.textContent = g.name; 
      garageSelect.appendChild(option); 
    });
  }

  async function fetchMaintenances() {
    return new Promise(resolve => {
      setTimeout(() => {
        if (allMaintenances.length === 0) {
          const baseTime = Date.now();
          for (let i = 1; i <= 25; i++) { 
            const daysAgo = Math.floor(Math.random() * 120); 
            const maintenanceDate = new Date(baseTime - daysAgo * 24 * 60 * 60 * 1000);
            const createdAtSlightlyBefore = new Date(maintenanceDate.getTime() - Math.floor(Math.random() * 24 * 60 * 60 * 1000)); 
            allMaintenances.push({
              id: i,
              cat_maintenance_id: mockMaintenanceCategories[Math.floor(Math.random() * mockMaintenanceCategories.length)].id,
              vehicle_id: mockVehicles[Math.floor(Math.random() * mockVehicles.length)].id,
              garage_id: mockGarages[Math.floor(Math.random() * mockGarages.length)].id,
              maintenance_cost: parseFloat((Math.random() * 300 + 20).toFixed(2)),
              receipt: `MNT-RCPT-${Math.random().toString(36).substr(2, 7).toUpperCase()}`,
              maintenance_date: maintenanceDate.toISOString(),
              created_at: createdAtSlightlyBefore.toISOString()
            });
          }
        }
        currentMaintenancePage = 1; 
        renderMaintenancesTable(); 
        resolve();
      }, 150);
    });
  }

  function renderMaintenancesTable() {
    let recordsToDisplay = [...allMaintenances];
    if (activeMaintenanceDateFilter !== 'all') {
      let range;
      if (activeMaintenanceDateFilter === 'custom' && customMaintenanceFilterStartDate && customMaintenanceFilterEndDate) {
        range = { startDate: customMaintenanceFilterStartDate, endDate: customMaintenanceFilterEndDate };
      } else {
        range = getDateRange(activeMaintenanceDateFilter);
      }
      if (range.startDate && range.endDate) {
        recordsToDisplay = recordsToDisplay.filter(m => {
          const maintenanceD = getISODateString(new Date(m.maintenance_date));
          return maintenanceD >= range.startDate && maintenanceD <= range.endDate;
        });
      }
    }
    const searchTerm = document.getElementById('maintenanceSearch').value.toLowerCase();
    if (searchTerm) {
      recordsToDisplay = recordsToDisplay.filter(m =>
        (m.id.toString().includes(searchTerm)) ||
        (mockMaintenanceCategories.find(cat => cat.id === m.cat_maintenance_id)?.name.toLowerCase().includes(searchTerm)) ||
        (mockVehicles.find(v => v.id === m.vehicle_id)?.name.toLowerCase().includes(searchTerm)) ||
        (m.maintenance_cost.toString().includes(searchTerm)) ||
        (m.receipt.toLowerCase().includes(searchTerm)) ||
        (mockGarages.find(g => g.id === m.garage_id)?.name.toLowerCase().includes(searchTerm))
      );
    }

    const start = (currentMaintenancePage - 1) * maintenancesPerPage;
    const paginatedRecords = recordsToDisplay.slice(start, start + maintenancesPerPage);
    const maintenancesBody = document.getElementById('maintenancesBody');
    maintenancesBody.innerHTML = paginatedRecords.length > 0 ? paginatedRecords.map(m => {
      const categoryName = mockMaintenanceCategories.find(cat => cat.id === m.cat_maintenance_id)?.name || m.cat_maintenance_id;
      const vehicleName = mockVehicles.find(v => v.id === m.vehicle_id)?.name || m.vehicle_id;
      const garageName = mockGarages.find(g => g.id === m.garage_id)?.name || m.garage_id;

      return `<tr class="border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors" data-id="${m.id}">
                <td class="py-3 px-2">${m.id}</td>
                <td class="px-2">${categoryName}</td>
                <td class="px-2">${vehicleName}</td>
                <td class="px-2">${m.maintenance_cost.toFixed(2)}</td>
                <td class="px-2 truncate max-w-[100px] sm:max-w-xs" title="${m.receipt}">${m.receipt}</td>
                <td class="px-2">${garageName}</td>
                <td class="px-2">${new Date(m.maintenance_date).toLocaleDateString()}</td>
                <td class="px-2 text-center whitespace-nowrap">
                  <button onclick="openViewMaintenanceModal(${m.id})" class="text-green-600 dark:text-green-400 hover:underline p-1" title="View Details"><i data-lucide="eye" class="w-4 h-4 inline-block"></i></button>
                  <button onclick="openEditMaintenanceModal(${m.id})" class="text-blue-600 dark:text-blue-400 hover:underline p-1 ml-1" title="Edit Record"><i data-lucide="edit-2" class="w-4 h-4 inline-block"></i></button>
                  <button onclick="openConfirmDeleteMaintenanceModal(${m.id})" class="text-red-600 dark:text-red-400 hover:underline p-1 ml-1" title="Delete Record"><i data-lucide="trash-2" class="w-4 h-4 inline-block"></i></button>
                </td></tr>`;
    }).join('') : `<tr><td colspan="8" class="text-center py-8 text-gray-500">No maintenance records found.</td></tr>`;
    lucide.createIcons();
    document.getElementById('maintenancesCount').textContent = `Showing ${paginatedRecords.length > 0 ? start + 1 : 0} to ${Math.min(start + maintenancesPerPage, recordsToDisplay.length)} of ${recordsToDisplay.length} records`;
    renderMaintenancePagination(recordsToDisplay.length);
  }

  function renderMaintenancePagination(totalRecords) { 
    const totalPages = Math.ceil(totalRecords / maintenancesPerPage);
    const paginationContainer = document.getElementById('maintenancesPagination');
    paginationContainer.innerHTML = '';
    if (totalPages <= 1) return;

    const btnClasses = "px-3 py-1.5 text-sm rounded-md transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-offset-1 dark:focus:ring-offset-gray-900 focus:ring-blue-500";
    const itemClasses = "bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700";
    const activeClasses = "bg-blue-500 text-white border border-blue-500 hover:bg-blue-600";
    const disabledClasses = "bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-400 dark:text-gray-500 cursor-not-allowed";

    const prevButton = document.createElement('button');
    prevButton.innerHTML = `<i data-lucide="chevron-left" class="w-4 h-4 inline-block mr-1"></i> Prev`;
    prevButton.className = `${btnClasses} ${currentMaintenancePage === 1 ? disabledClasses : itemClasses}`;
    if (currentMaintenancePage > 1) prevButton.onclick = () => { currentMaintenancePage--; renderMaintenancesTable(); };
    else prevButton.disabled = true;
    paginationContainer.appendChild(prevButton);

    const pagesToShow = [];
    if (totalPages <= 5) {
      for (let i = 1; i <= totalPages; i++) pagesToShow.push(i);
    } else {
      pagesToShow.push(1);
      if (currentMaintenancePage > 3) pagesToShow.push('...');
      for (let i = Math.max(2, currentMaintenancePage - 1); i <= Math.min(totalPages - 1, currentMaintenancePage + 1); i++) {
        if (!pagesToShow.includes(i)) pagesToShow.push(i);
      }
      if (currentMaintenancePage < totalPages - 2) pagesToShow.push('...');
      if (!pagesToShow.includes(totalPages)) pagesToShow.push(totalPages);
    }

    pagesToShow.forEach(pageNum => {
      if (pageNum === '...') {
        const ellipsis = document.createElement('span');
        ellipsis.textContent = '...';
        ellipsis.className = "px-3 py-1.5 text-sm text-gray-500 dark:text-gray-400";
        paginationContainer.appendChild(ellipsis);
      } else {
        const pageButton = document.createElement('button');
        pageButton.textContent = pageNum;
        pageButton.className = `${btnClasses} ${pageNum === currentMaintenancePage ? activeClasses : itemClasses}`;
        pageButton.onclick = () => { currentMaintenancePage = pageNum; renderMaintenancesTable(); };
        paginationContainer.appendChild(pageButton);
      }
    });

    const nextButton = document.createElement('button');
    nextButton.innerHTML = `Next <i data-lucide="chevron-right" class="w-4 h-4 inline-block ml-1"></i>`;
    nextButton.className = `${btnClasses} ${currentMaintenancePage === totalPages ? disabledClasses : itemClasses}`;
    if (currentMaintenancePage < totalPages) nextButton.onclick = () => { currentMaintenancePage++; renderMaintenancesTable(); };
    else nextButton.disabled = true;
    paginationContainer.appendChild(nextButton);
    lucide.createIcons();
  }
  
  function openAddMaintenanceModal() {
    maintenanceToEditId = null; 
    document.getElementById('addMaintenanceForm').reset();
    document.getElementById('maintenanceModalTitle').textContent = "Add New Maintenance";
    document.getElementById('maintenanceSubmitButton').innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4"></i> Add Maintenance`;
    populateMaintenanceDropdowns(); 
    lucide.createIcons(); 
    document.getElementById('addMaintenanceModal').classList.remove('hidden'); 
    document.body.style.overflow = 'hidden';
  }

  async function openEditMaintenanceModal(id) {
    const m = allMaintenances.find(rec => rec.id === id); 
    if (!m) { alert("Maintenance record not found!"); return; }
    maintenanceToEditId = id; 
    document.getElementById('maintenanceModalTitle').textContent = "Edit Maintenance Record";
    document.getElementById('maintenanceSubmitButton').innerHTML = `<i data-lucide="save" class="w-4 h-4"></i> Save Changes`;
    await populateMaintenanceDropdowns(); 
    lucide.createIcons(); 
    document.getElementById('maintenanceId_form').value = m.id;
    document.getElementById('cat_maintenance_id_form').value = m.cat_maintenance_id;
    document.getElementById('vehicle_id_form').value = m.vehicle_id;
    document.getElementById('maintenance_cost_form').value = m.maintenance_cost;
    document.getElementById('maintenance_receipt_form').value = m.receipt;
    document.getElementById('maintenance_garage_id_form').value = m.garage_id;
    document.getElementById('maintenance_date_form').value = new Date(m.maintenance_date).toISOString().split('T')[0];
    document.getElementById('addMaintenanceModal').classList.remove('hidden'); 
    document.body.style.overflow = 'hidden';
  }

  function closeAddMaintenanceModal() { 
    document.getElementById('addMaintenanceModal').classList.add('hidden'); 
    document.body.style.overflow = ''; 
    maintenanceToEditId = null; 
  }

  function openViewMaintenanceModal(id) {
    const m = allMaintenances.find(rec => rec.id === id); 
    if (!m) { alert("Maintenance record not found!"); return; }
    document.getElementById('view-maintenance-id').textContent = m.id;
    document.getElementById('view-maintenance-category').textContent = mockMaintenanceCategories.find(cat => cat.id === m.cat_maintenance_id)?.name || 'N/A';
    document.getElementById('view-maintenance-vehicle').textContent = mockVehicles.find(v => v.id === m.vehicle_id)?.name || 'N/A';
    document.getElementById('view-maintenance-cost').textContent = `$${m.maintenance_cost.toFixed(2)}`;
    document.getElementById('view-maintenance-receipt').textContent = m.receipt;
    document.getElementById('view-maintenance-garage').textContent = mockGarages.find(g => g.id === m.garage_id)?.name || 'N/A';
    document.getElementById('view-maintenance-maintenance_date').textContent = new Date(m.maintenance_date).toLocaleDateString();
    document.getElementById('view-maintenance-created_at').textContent = new Date(m.created_at).toLocaleString();
    document.getElementById('viewMaintenanceModal').classList.remove('hidden'); 
    document.body.style.overflow = 'hidden'; 
    lucide.createIcons();
  }

  function closeViewMaintenanceModal() { 
    document.getElementById('viewMaintenanceModal').classList.add('hidden'); 
    document.body.style.overflow = ''; 
  }

  async function handleMaintenanceFormSubmit(event) {
    event.preventDefault();
    const data = {
      cat_maintenance_id: parseInt(document.getElementById('cat_maintenance_id_form').value),
      vehicle_id: parseInt(document.getElementById('vehicle_id_form').value),
      maintenance_cost: parseFloat(document.getElementById('maintenance_cost_form').value),
      receipt: document.getElementById('maintenance_receipt_form').value,
      garage_id: parseInt(document.getElementById('maintenance_garage_id_form').value),
      maintenance_date: new Date(document.getElementById('maintenance_date_form').value).toISOString()
    };

    if (!data.cat_maintenance_id || !data.vehicle_id || isNaN(data.maintenance_cost) || !data.receipt || !data.garage_id || !data.maintenance_date) {
      alert("Please fill all Maintenance fields correctly."); return;
    }

    return new Promise(resolve => {
      setTimeout(() => {
        if (maintenanceToEditId) {
          const index = allMaintenances.findIndex(m => m.id === maintenanceToEditId);
          if (index !== -1) {
            allMaintenances[index] = { ...allMaintenances[index], ...data }; 
          }
          alert('Maintenance record updated (mock)!');
        } else {
          const newRecord = { 
            ...data, 
            id: allMaintenances.length > 0 ? Math.max(...allMaintenances.map(m => m.id)) + 1 : 1,
            created_at: new Date().toISOString() 
          };
          allMaintenances.unshift(newRecord);
          alert('Maintenance record added (mock)!');
        }
        closeAddMaintenanceModal(); 
        currentMaintenancePage = 1; 
        renderMaintenancesTable(); 
        resolve();
      }, 150);
    });
  }

  function openConfirmDeleteMaintenanceModal(id) { 
    maintenanceToDeleteId = id; 
    document.getElementById('confirmDeleteMaintenanceModal').classList.remove('hidden'); 
    document.body.style.overflow = 'hidden'; 
  }
  function closeConfirmDeleteMaintenanceModal() { 
    maintenanceToDeleteId = null; 
    document.getElementById('confirmDeleteMaintenanceModal').classList.add('hidden'); 
    document.body.style.overflow = ''; 
  }
  async function confirmDeleteMaintenance() {
    if (!maintenanceToDeleteId) return;
    return new Promise(resolve => {
      setTimeout(() => {
        allMaintenances = allMaintenances.filter(m => m.id !== maintenanceToDeleteId);
        closeConfirmDeleteMaintenanceModal();
        if (document.getElementById('maintenancesBody').childElementCount === 1 && currentMaintenancePage > 1 && allMaintenances.length > 0) {
          currentMaintenancePage--; 
        }
        renderMaintenancesTable(); 
        alert('Maintenance record deleted (mock)!'); 
        resolve();
      }, 150);
    });
  }

  function exportMaintenancesExcel() {
    let recordsToExport = [...allMaintenances]; 
    if (activeMaintenanceDateFilter !== 'all') { 
      let range = (activeMaintenanceDateFilter === 'custom' && customMaintenanceFilterStartDate && customMaintenanceFilterEndDate) ? 
                  {startDate:customMaintenanceFilterStartDate,endDate:customMaintenanceFilterEndDate} : 
                  getDateRange(activeMaintenanceDateFilter); 
      if (range.startDate && range.endDate) { 
        recordsToExport = recordsToExport.filter(m => { 
          const maintenanceD = getISODateString(new Date(m.maintenance_date)); 
          return maintenanceD >= range.startDate && maintenanceD <= range.endDate; 
        }); 
      } 
    }
    const searchTerm = document.getElementById('maintenanceSearch').value.toLowerCase(); 
    if (searchTerm) { 
      recordsToExport = recordsToExport.filter(m =>
        (m.id.toString().includes(searchTerm)) ||
        (mockMaintenanceCategories.find(cat => cat.id === m.cat_maintenance_id)?.name.toLowerCase().includes(searchTerm)) ||
        (mockVehicles.find(v => v.id === m.vehicle_id)?.name.toLowerCase().includes(searchTerm)) ||
        (m.maintenance_cost.toString().includes(searchTerm)) ||
        (m.receipt.toLowerCase().includes(searchTerm)) ||
        (mockGarages.find(g => g.id === m.garage_id)?.name.toLowerCase().includes(searchTerm))
      );
    }
    const worksheetData = recordsToExport.map(m => ({ 
        ID: m.id, 
        Category: mockMaintenanceCategories.find(cat=>cat.id===m.cat_maintenance_id)?.name || m.cat_maintenance_id, 
        Vehicle: mockVehicles.find(v=>v.id===m.vehicle_id)?.name || m.vehicle_id,
        Cost: m.maintenance_cost.toFixed(2), 
        Receipt: m.receipt, 
        Garage: mockGarages.find(g=>g.id===m.garage_id)?.name || m.garage_id, 
        'Maintenance Date': new Date(m.maintenance_date).toLocaleDateString(),
        'Created At': new Date(m.created_at).toLocaleString()
    }));
    const worksheet = XLSX.utils.json_to_sheet(worksheetData); 
    const workbook = XLSX.utils.book_new(); 
    XLSX.utils.book_append_sheet(workbook, worksheet, "Maintenances"); 
    XLSX.writeFile(workbook, "maintenances_export.xlsx");
  }

  function exportMaintenancesPDF() {
    const {jsPDF} = window.jspdf; 
    const doc = new jsPDF(); 
    doc.setFontSize(18); 
    doc.text('Maintenance Records', 14, 15);
    
    let recordsToExport = [...allMaintenances]; 
    if (activeMaintenanceDateFilter !== 'all') { 
      let range = (activeMaintenanceDateFilter === 'custom' && customMaintenanceFilterStartDate && customMaintenanceFilterEndDate) ? 
                  {startDate:customMaintenanceFilterStartDate,endDate:customMaintenanceFilterEndDate} : 
                  getDateRange(activeMaintenanceDateFilter); 
      if (range.startDate && range.endDate) { 
        recordsToExport = recordsToExport.filter(m => { 
          const maintenanceD = getISODateString(new Date(m.maintenance_date)); 
          return maintenanceD >= range.startDate && maintenanceD <= range.endDate; 
        }); 
      } 
    }
    const searchTerm = document.getElementById('maintenanceSearch').value.toLowerCase(); 
    if (searchTerm) { 
        recordsToExport = recordsToExport.filter(m =>
        (m.id.toString().includes(searchTerm)) ||
        (mockMaintenanceCategories.find(cat => cat.id === m.cat_maintenance_id)?.name.toLowerCase().includes(searchTerm)) ||
        (mockVehicles.find(v => v.id === m.vehicle_id)?.name.toLowerCase().includes(searchTerm)) ||
        (m.maintenance_cost.toString().includes(searchTerm)) ||
        (m.receipt.toLowerCase().includes(searchTerm)) ||
        (mockGarages.find(g => g.id === m.garage_id)?.name.toLowerCase().includes(searchTerm))
      );
    }

    const headers = [['ID', 'Category', 'Vehicle', 'Cost', 'Receipt', 'Garage', 'Maintenance Date', 'Created At']];
    const data = recordsToExport.map(m => [
        m.id, 
        mockMaintenanceCategories.find(cat=>cat.id===m.cat_maintenance_id)?.name || m.cat_maintenance_id, 
        mockVehicles.find(v=>v.id===m.vehicle_id)?.name || m.vehicle_id,
        m.maintenance_cost.toFixed(2), 
        m.receipt, 
        mockGarages.find(g=>g.id===m.garage_id)?.name || m.garage_id, 
        new Date(m.maintenance_date).toLocaleDateString(),
        new Date(m.created_at).toLocaleDateString() 
    ]);
    doc.autoTable({ 
        head: headers, 
        body: data, 
        startY: 25, 
        theme: 'grid', 
        headStyles: {fillColor: [59,130,246], textColor: 255},
        columnStyles: { 
            2: { cellWidth: 30 }, 
            4: { cellWidth: 30 }  
        } 
    }); 
    doc.save('maintenances_export.pdf');
  }
</script>
</body>
</html>