<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Fuel Log Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <style>
    .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
    .modal.hidden { visibility: hidden; opacity: 0; }
    .modal:not(.hidden) { visibility: visible; opacity: 1; }
    .dark .modal-content { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5), 0 10px 10px -5px rgba(0,0,0,0.2); }
    .date-filter-btn.active { background-color: #3b82f6; color: white; }
    .dark .date-filter-btn.active { background-color: #60a5fa; }
    .view-detail-label { font-weight: 500; color: #4b5563; }
    .dark .view-detail-label { color: #d1d5db; }
    .view-detail-value { color: #1f2937; }
    .dark .view-detail-value { color: #f9fafb; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white">
<div class="flex flex-col md:flex-row h-screen overflow-hidden">

    <!-- Sidebar (Left) -->
    <aside class="w-64 bg-white dark:bg-gray-800/95 backdrop-blur-sm p-4 space-y-6 shadow-lg hidden md:block flex-shrink-0 border-r dark:border-gray-700">
      <div class="text-2xl font-bold flex items-center space-x-2 text-primary dark:text-primary-light">
        <i data-lucide="command" class="w-7 h-7"></i><span>FleetDash</span>
      </div>
      <nav class="flex-1">
        <ul class="space-y-2">
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="layout-dashboard" class="w-5 h-5"></i><a href="dashboard">Dashboard</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="pie-chart" class="w-5 h-5"></i><a href="analytics">Analytics</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="users" class="w-5 h-5"></i><a href="users">User</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="user" class="w-5 h-5"></i><a href="driver">Driver</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="alert-triangle" class="w-5 h-5"></i><a href="panne">Pannes (Issues)</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="car" class="w-5 h-5"></i><a href="vehicle">Vehicles</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="wrench" class="w-5 h-5"></i><a href="reparation">Reparation</a>
            </li>
            <li class="flex items-center space-x-3 text-blue-600 dark:text-blue-400 font-semibold bg-blue-50 dark:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="droplet" class="w-5 h-5"></i><a href="fuel">Fuel</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="settings" class="w-5 h-5"></i><a href="maintenance">Maintenance</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="route" class="w-5 h-5"></i><a href="trip">Trip</a>
            </li>
        </ul>
      </nav>
       <div class="pt-4 border-t border-gray-200 dark:border-gray-700/50 mt-auto">
            <a href="#" id="global-logout-btn" class="flex items-center space-x-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/40 p-2.5 rounded-lg transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i><span>Logout</span>
            </a>
       </div>
    </aside>

  <!-- Main content -->
  <main class="flex-1 overflow-auto p-6">
    <section id="fuel-section" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow mb-6">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
        <div class="flex flex-wrap gap-2 items-center">
          <button id="openAddFuelModalButton" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-1 text-sm shadow-sm">
            <i data-lucide="plus" class="w-4 h-4"></i> Add Fuel Log
          </button>
           <select id="fuelVehicleFilter" class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm text-black dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-auto">
                <option value="">All Vehicles</option>
            </select>
            <select id="fuelFuelTypeFilter" class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm text-black dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-auto">
                <option value="">All Fuel Types</option>
            </select>
        </div>
        <div class="flex flex-wrap gap-2 items-center">
          <button id="exportExcelButton" class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 text-sm shadow-sm">ðŸ“„ Excel</button>
          <button id="exportPdfButton" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm shadow-sm">ðŸ§¾ PDF</button>
        </div>
      </div>

      <div class="mb-4 flex flex-wrap items-center gap-2">
        <span class="text-sm font-medium mr-2">Filter by Date Recorded:</span>
        <button id="fuel-filter-today" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Today</button>
        <button id="fuel-filter-last7" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Last 7 Days</button>
        <button id="fuel-filter-last30" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Last 30 Days</button>
        <button id="fuel-filter-all" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 active">All Time</button>
        <button id="fuel-filter-custom-btn" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Custom Range</button>
      </div>
      <div id="fuelCustomDateRange" class="mb-4 hidden items-center gap-2 p-3 border dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-800/50">
        <input type="date" id="fuelCustomStartDate" class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
        <span class="text-sm">to</span>
        <input type="date" id="fuelCustomEndDate" class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
        <button id="applyCustomDateFilterButton" class="bg-blue-500 text-white px-3 py-1.5 text-sm rounded-md hover:bg-blue-600">Apply</button>
      </div>

      <div class="overflow-x-auto">
        <table id="fuelLogTable" class="w-full text-left text-sm">
          <thead>
            <tr class="border-b dark:border-gray-700">
              <th class="py-3 px-2 font-semibold">ID</th>
              <th class="px-2 font-semibold">Vehicle (Plate)</th>
              <th class="px-2 font-semibold">Fuel Type</th>
              <th class="px-2 font-semibold text-right">Quantity</th>
              <th class="px-2 font-semibold text-right">Price/Unit ($)</th>
              <th class="px-2 font-semibold text-right">Total Cost ($)</th>
              <th class="px-2 font-semibold">Date Recorded</th>
              <th class="px-2 font-semibold text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="fuelLogBody"></tbody>
        </table>
      </div>
      <div class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
        <div class="text-sm text-gray-600 dark:text-gray-400" id="fuelLogCount"></div>
        <div class="flex items-center space-x-1" id="fuelLogPagination"></div>
      </div>
    </section>
  </main>

    <aside class="w-1/5 bg-white dark:bg-gray-800 p-4 space-y-6 shadow-md hidden lg:block flex-shrink-0">
        <div class="flex justify-between items-center">
        <button id="theme-toggle" class="text-xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">ðŸŒ™</button>
        <div><div class="text-sm font-semibold" id="userDisplayName">User</div><div class="text-xs text-gray-500 dark:text-gray-300">Admin</div></div>
        </div>
        <div><h4 class="font-bold mb-4 text-lg">Fuel Insights</h4><p class="text-xs text-gray-500 dark:text-gray-400">Avg Price/L: N/A</p><p class="text-xs text-gray-500 dark:text-gray-400">Total Cost (Month): N/A</p></div>
    </aside>
</div>

<!-- Add/Edit Fuel Log Modal -->
<div id="addFuelModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="fuelModalTitle">Add New Fuel Log</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400">Enter transaction details</p>
        </div>
        <button id="closeAddFuelModalButtonTop" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <form id="addFuelForm" class="space-y-4">
        <input type="hidden" id="fuelId_form">
        <div>
          <label for="fuel_vehicle_id_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Vehicle</label>
          <select id="fuel_vehicle_id_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"></select>
        </div>
        <div>
          <label for="fuel_fuel_type_id_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fuel Type</label>
          <select id="fuel_fuel_type_id_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"></select>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="fuel_quantity_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Quantity (Liters/kWh)</label>
              <input type="number" step="0.01" id="fuel_quantity_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="e.g., 50.25">
            </div>
            <div>
              <label for="fuel_price_little_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Price per Unit ($)</label>
              <input type="number" step="0.001" id="fuel_price_little_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="e.g., 1.500">
            </div>
        </div>
        <div class="mt-2" id="calculatedCostDisplayArea" style="display: none;">
            <p class="text-sm text-gray-600 dark:text-gray-400">Estimated Total Cost: <span id="displayCalculatedCost" class="font-semibold"></span></p>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" id="cancelAddFuelModalButton" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
          <button type="submit" id="fuelSubmitButton" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
            <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Log
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- View Fuel Log Modal -->
<div id="viewFuelModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white">Fuel Log Details</h3>
        <button id="closeViewFuelModalButtonTop" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <div id="viewFuelDetails" class="space-y-3 text-sm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3">
            <div><span class="view-detail-label">Log ID:</span> <span id="view-fuel-id" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Vehicle:</span> <span id="view-fuel-vehicle" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Fuel Type:</span> <span id="view-fuel-fuel_type" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Quantity:</span> <span id="view-fuel-quantity" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Price/Unit:</span> <span id="view-fuel-price_little" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Total Cost:</span> <span id="view-fuel-cost" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Date Recorded:</span> <span id="view-fuel-created_at" class="view-detail-value"></span></div>
        </div>
      </div>
      <div class="flex justify-end pt-6">
          <button type="button" id="closeViewFuelModalButtonBottom" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Generic Confirmation Modal -->
<div id="genericConfirmModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
    <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="genericConfirmModalTitle" class="text-xl font-bold text-gray-800 dark:text-white">Confirm Action</h3>
                <button id="closeGenericConfirmModalButtonX" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
                </button>
            </div>
            <p id="genericConfirmModalMessage" class="text-sm text-gray-600 dark:text-gray-400 mb-6">Are you sure?</p>
            <div class="flex justify-end gap-3 pt-4">
                <button id="cancelGenericConfirmModalButton" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                <button id="genericConfirmModalConfirmBtn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
                  {/* Content set by JS */} Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Information/Status Modal -->
<div id="infoStatusModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
    <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
        <div class="p-6 text-center">
            <div id="infoStatusModalIconContainer" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
              {/* Icon set by JS */}
            </div>
            <h3 id="infoStatusModalTitle" class="text-lg font-medium text-gray-900 dark:text-white mb-2">Status</h3>
            <div class="mt-2">
                <p id="infoStatusModalMessage" class="text-sm text-gray-500 dark:text-gray-400">Message.</p>
            </div>
            <div class="mt-5">
                <button type="button" id="infoStatusModalOkButton" class="w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">OK</button>
            </div>
        </div>
    </div>
</div>

<script>
  const API_BASE_URL = 'http://localhost:8000';
  const LOGIN_PAGE_URL = 'login.html';

  // --- CORE HELPER FUNCTIONS ---
  function getAuthToken() { return localStorage.getItem('accessToken'); }
  function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { console.error("DEBUG JWT Parse Error:", e, "Token:", token); return null; }}

  function updateUserInfoDisplay() {
    const token = getAuthToken(); const userDisplayElement = document.getElementById('userDisplayName');
    if (!userDisplayElement) { return; }
    if (token) { const decoded = parseJwt(token); userDisplayElement.textContent = (decoded && decoded.sub) ? decoded.sub : 'User (Error)';}
    else { userDisplayElement.textContent = 'Guest'; }
  }

  async function apiRequest(endpoint, method = 'GET', body = null) {
    const token = getAuthToken();
    const headers = { 'Content-Type': 'application/json' };
    if (token && !endpoint.startsWith('/login')) { headers['Authorization'] = `Bearer ${token}`; }
    else if (!token && !endpoint.startsWith('/login')) { console.warn(`DEBUG WARN: Protected endpoint ${endpoint} called without token.`); }

    const config = { method, headers };
    if (body) config.body = JSON.stringify(body);
    // console.log(`DEBUG API Request: ${method} ${API_BASE_URL}${endpoint}`, body ? `Body: ${JSON.stringify(body)}` : '');

    try {
      const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
      const responseForJson = response.clone();
      const responseForText = response.clone();

      if (response.status === 401 && !endpoint.endsWith('/login/')) {
        openInfoStatusModal("Authentication Error", "Session expired or unauthorized. Please log in again.", "error", 5000);
        return null;
      }
      if (response.status === 204) return true;

      const responseData = await responseForJson.json().catch(async (jsonError) => {
          const text = await responseForText.text();
          console.error(`DEBUG JSON Parse Error for ${endpoint}. Status: ${response.status}. Response: ${text.substring(0,200)}...`, jsonError);
          if (!response.ok) { return Promise.reject({ status: response.status, detail: text || `Server error ${response.status}` }); }
          return Promise.reject({ status: response.status, detail: `Invalid JSON (Status: ${response.status}). Text: ${text.substring(0,100)}` });
      });

      if (!response.ok) {
        const errorDetail = responseData.detail || (typeof responseData === 'object' ? JSON.stringify(responseData) : responseData) || 'Unknown server error.';
        console.error(`DEBUG API Error for ${endpoint}: ${response.status}`, errorDetail);
        if (!(response.status === 401 && endpoint.endsWith('/login/'))) {
          openInfoStatusModal(`API Error: ${response.status}`, errorDetail, "error");
        }
        return null;
      }
      return responseData;
    } catch (error) {
      console.error(`DEBUG Network/Catch Error for ${endpoint}:`, error);
      const errorMessage = error.detail || error.message || "A network or request error occurred.";
      openInfoStatusModal("Request Error", errorMessage, "error");
      return null;
    }
  }
  // --- END CORE HELPER FUNCTIONS ---

  let allFetchedFuelLogsFromServer = [];
  let vehicleDataForDropdown_fuel = [];
  let fuelTypeDataForDropdown_fuel = [];
  const fuelLogsPerPage = 10;
  let currentFuelLogPage = 1;
  let fuelLogToEditId = null;
  let activeFuelDateFilter = 'all';
  let customFuelFilterStartDate = null;
  let customFuelFilterEndDate = null;

  let currentConfirmAction = null;
  let currentActionData = null;
  let infoStatusModalTimeout = null;

  // --- MODAL CLOSE FUNCTIONS ---
  function closeAddFuelModal() {
    const modal = document.getElementById('addFuelModal'); if (modal) modal.classList.add('hidden');
    document.body.style.overflow = ''; fuelLogToEditId = null;
    const form = document.getElementById('addFuelForm'); if (form) form.reset();
    const displayArea = document.getElementById('calculatedCostDisplayArea'); if (displayArea) displayArea.style.display = 'none';
  }
  function closeViewFuelModal() {
    const modal = document.getElementById('viewFuelModal'); if(modal) modal.classList.add('hidden'); document.body.style.overflow = '';
  }
  function closeGenericConfirmModal() {
    const modal = document.getElementById('genericConfirmModal'); if (modal) modal.classList.add('hidden');
    document.body.style.overflow = ''; currentConfirmAction = null; currentActionData = null;
  }
  function closeInfoStatusModal() {
    if (infoStatusModalTimeout) { clearTimeout(infoStatusModalTimeout); infoStatusModalTimeout = null; }
    const modal = document.getElementById('infoStatusModal'); if(modal) modal.classList.add('hidden');
    document.body.style.overflow = '';
  }

  // --- MODAL OPEN FUNCTIONS (Generic & Info/Status) ---
  function openGenericConfirmModal(title, message, confirmButtonText, confirmButtonIconName, onConfirmCallback, actionData = null) {
    document.getElementById('genericConfirmModalTitle').textContent = title;
    document.getElementById('genericConfirmModalMessage').textContent = message;

    const confirmBtnEl = document.getElementById('genericConfirmModalConfirmBtn');
    confirmBtnEl.innerHTML = ''; // Clear previous
    if (confirmButtonIconName) {
        const icon = document.createElement('i');
        icon.setAttribute('data-lucide', confirmButtonIconName);
        icon.classList.add('w-4', 'h-4', 'mr-2');
        confirmBtnEl.appendChild(icon);
    }
    confirmBtnEl.appendChild(document.createTextNode(confirmButtonText || 'Confirm'));

    if(confirmButtonIconName === 'trash-2' || confirmButtonText.toLowerCase().includes('delete')){
        confirmBtnEl.classList.remove('bg-blue-500', 'hover:bg-blue-600');
        confirmBtnEl.classList.add('bg-red-500', 'hover:bg-red-600');
    } else {
        confirmBtnEl.classList.remove('bg-red-500', 'hover:bg-red-600');
        confirmBtnEl.classList.add('bg-blue-500', 'hover:bg-blue-600');
    }

    if (typeof lucide !== 'undefined') lucide.createIcons({ nodes: [confirmBtnEl] });

    currentConfirmAction = onConfirmCallback;
    currentActionData = actionData;

    document.getElementById('genericConfirmModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function openInfoStatusModal(title, message, type = 'info', autoCloseDelay = 3000) {
    const modal = document.getElementById('infoStatusModal');
    const modalTitleEl = document.getElementById('infoStatusModalTitle');
    const modalMessageEl = document.getElementById('infoStatusModalMessage');
    const iconContainer = document.getElementById('infoStatusModalIconContainer');
    const okButton = document.getElementById('infoStatusModalOkButton');

    modalTitleEl.textContent = title;
    modalMessageEl.textContent = message;

    if (infoStatusModalTimeout) clearTimeout(infoStatusModalTimeout);
    iconContainer.innerHTML = '';
    let iconName = 'info'; let iconColor = 'blue'; let bgColor = 'blue';

    switch (type.toLowerCase()) {
        case 'success': iconName = 'check-circle'; iconColor = 'green'; bgColor = 'green'; break;
        case 'error': iconName = 'alert-circle'; iconColor = 'red'; bgColor = 'red'; break;
    }

    iconContainer.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-${bgColor}-100 dark:bg-${bgColor}-800 mb-4`;
    const iconEl = document.createElement('i');
    iconEl.setAttribute('data-lucide', iconName);
    iconEl.className = `w-6 h-6 text-${iconColor}-600 dark:text-${iconColor}-400`;
    iconContainer.appendChild(iconEl);

    okButton.className = `w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-${iconColor}-600 text-base font-medium text-white hover:bg-${iconColor}-700 focus:ring-2 focus:ring-offset-2 focus:ring-${iconColor}-500 dark:focus:ring-offset-gray-800`;

    if (typeof lucide !== 'undefined') lucide.createIcons({ nodes: [iconContainer] });

    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    if (autoCloseDelay && autoCloseDelay > 0) {
        infoStatusModalTimeout = setTimeout(() => { closeInfoStatusModal(); }, autoCloseDelay);
    }
  }


  // --- DOMContentLoaded Event Listener ---
  document.addEventListener('DOMContentLoaded', async () => {
      lucide.createIcons();
      updateUserInfoDisplay();
      document.getElementById('theme-toggle')?.addEventListener('click', () => document.documentElement.classList.toggle('dark'));

      document.getElementById('addFuelModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeAddFuelModal(); });
      document.getElementById('viewFuelModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeViewFuelModal(); });
      document.getElementById('genericConfirmModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeGenericConfirmModal(); });
      document.getElementById('infoStatusModal').addEventListener('click', e => { if (e.target.id === 'infoStatusModal' || e.target.closest('#infoStatusModalOkButton')) closeInfoStatusModal(); });

      document.getElementById('closeAddFuelModalButtonTop')?.addEventListener('click', closeAddFuelModal);
      document.getElementById('cancelAddFuelModalButton')?.addEventListener('click', closeAddFuelModal);
      document.getElementById('closeViewFuelModalButtonTop')?.addEventListener('click', closeViewFuelModal);
      document.getElementById('closeViewFuelModalButtonBottom')?.addEventListener('click', closeViewFuelModal);
      document.getElementById('closeGenericConfirmModalButtonX')?.addEventListener('click', closeGenericConfirmModal);
      document.getElementById('cancelGenericConfirmModalButton')?.addEventListener('click', closeGenericConfirmModal);

      document.getElementById('genericConfirmModalConfirmBtn').addEventListener('click', async () => {
        if (typeof currentConfirmAction === 'function') {
            console.log("DEBUG: genericConfirmModalConfirmBtn - Executing currentConfirmAction...");
            try {
                 await currentConfirmAction(currentActionData);
            } catch (error) {
                console.error("DEBUG: Uncaught error from currentConfirmAction:", error);
                openInfoStatusModal("Critical Action Error", "An unexpected error occurred: " + (error.message || error), "error");
            }
        } else {
            console.log("DEBUG: genericConfirmModalConfirmBtn - No currentConfirmAction defined.");
        }
        closeGenericConfirmModal();
      });

      document.getElementById('global-logout-btn')?.addEventListener('click', (e) => {
          e.preventDefault();
          localStorage.removeItem('accessToken');
          openInfoStatusModal("Logged Out", "Successfully logged out.", "success", 2500);
          updateUserInfoDisplay();
          allFetchedFuelLogsFromServer = [];
          renderFuelLogTable();
          // setTimeout(()=>window.location.href=LOGIN_PAGE_URL, 2500);
      });

      document.getElementById('fuel_quantity_form')?.addEventListener('input', displayDynamicCost);
      document.getElementById('fuel_price_little_form')?.addEventListener('input', displayDynamicCost);
      document.getElementById('openAddFuelModalButton')?.addEventListener('click', openAddFuelModal);
      document.getElementById('exportExcelButton')?.addEventListener('click', exportFuelLogsExcel);
      document.getElementById('exportPdfButton')?.addEventListener('click', exportFuelLogsPDF);
      document.getElementById('fuelVehicleFilter')?.addEventListener('change', applyFuelFilters);
      document.getElementById('fuelFuelTypeFilter')?.addEventListener('change', applyFuelFilters);
      document.getElementById('fuel-filter-today')?.addEventListener('click', () => applyFuelDateFilter('today'));
      document.getElementById('fuel-filter-last7')?.addEventListener('click', () => applyFuelDateFilter('last7days'));
      document.getElementById('fuel-filter-last30')?.addEventListener('click', () => applyFuelDateFilter('last30days'));
      document.getElementById('fuel-filter-all')?.addEventListener('click', () => applyFuelDateFilter('all'));
      document.getElementById('fuel-filter-custom-btn')?.addEventListener('click', toggleFuelCustomDateRange);
      document.getElementById('applyCustomDateFilterButton')?.addEventListener('click', applyFuelCustomDateFilter);

      const addFuelForm = document.getElementById('addFuelForm');
      if (addFuelForm) addFuelForm.addEventListener('submit', handleFuelFormSubmit);

      await initializeFuelLogSection();
  });

  // --- Fuel Specific Functions ---
  function displayDynamicCost() {
      const quantityEl = document.getElementById('fuel_quantity_form'); const priceLittleEl = document.getElementById('fuel_price_little_form');
      const displayArea = document.getElementById('calculatedCostDisplayArea'); const costSpan = document.getElementById('displayCalculatedCost');
      if (!quantityEl || !priceLittleEl || !displayArea || !costSpan) { return; }
      const quantity = parseFloat(quantityEl.value) || 0; const priceLittle = parseFloat(priceLittleEl.value) || 0;
      if (quantity > 0 && priceLittle > 0) { const calculated = (quantity * priceLittle).toFixed(2); costSpan.textContent = `$${calculated}`; displayArea.style.display = 'block'; }
      else { displayArea.style.display = 'none'; costSpan.textContent = ''; }
  }

  async function initializeFuelLogSection() {
    console.log("DEBUG: Initializing fuel log section...");
    await fetchDropdownDataForFuel();
    if (!getAuthToken()) {
        const fuelLogBody = document.getElementById('fuelLogBody'); if(fuelLogBody) fuelLogBody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-red-500">Please log in.</td></tr>`;
        const fuelLogCount = document.getElementById('fuelLogCount'); if(fuelLogCount) fuelLogCount.textContent = '0 records';
        const fuelLogPagination = document.getElementById('fuelLogPagination'); if(fuelLogPagination) fuelLogPagination.innerHTML = '';
    } else {
        await fetchFuelLogs();
    }
    setActiveFuelDateFilterButton('all');
  }

  async function fetchDropdownDataForFuel() {
    vehicleDataForDropdown_fuel = await apiRequest('/vehicle/?limit=1000') || [];
    fuelTypeDataForDropdown_fuel = await apiRequest('/fuel_type/?limit=100') || [];

    if (!Array.isArray(vehicleDataForDropdown_fuel)) vehicleDataForDropdown_fuel = [];
    if (!Array.isArray(fuelTypeDataForDropdown_fuel)) fuelTypeDataForDropdown_fuel = [];

    populateSelectWithOptionsGeneric('fuelVehicleFilter', vehicleDataForDropdown_fuel, 'id', 'plate_number', "All Vehicles", (v) => v.plate_number);
    populateSelectWithOptionsGeneric('fuelFuelTypeFilter', fuelTypeDataForDropdown_fuel, 'id', 'fuel_type', "All Fuel Types", (ft) => ft.fuel_type);

    populateSelectWithOptionsGeneric('fuel_vehicle_id_form', vehicleDataForDropdown_fuel, 'id', 'plate_number', "Select Vehicle", (v) => v.plate_number);
    populateSelectWithOptionsGeneric('fuel_fuel_type_id_form', fuelTypeDataForDropdown_fuel, 'id', 'fuel_type', "Select Fuel Type", (ft) => ft.fuel_type);
  }

  function populateSelectWithOptionsGeneric(selectElementId, optionsArray, valueField, textField, placeholder = "Select Option", displayFormatter = null) {
    const selectElement = document.getElementById(selectElementId);
    if (!selectElement) { console.warn(`Populate Warn: Element '${selectElementId}' not found.`); return; }

    const currentValue = selectElement.value;
    selectElement.innerHTML = `<option value="">${placeholder}</option>`;
    if (!Array.isArray(optionsArray) || optionsArray.length === 0) { selectElement.disabled = true; return; }
    selectElement.disabled = false;

    optionsArray.forEach((opt) => {
        if (typeof opt !== 'object' || opt === null) return;
        const option = document.createElement('option');
        const val = opt[valueField];
        option.value = (val === undefined) ? '' : val;

        let displayText = displayFormatter ? displayFormatter(opt) :
                          (opt[textField] !== undefined ? opt[textField] : `(ID: ${val !== undefined ? val : 'N/A'})`);
        option.textContent = displayText;
        selectElement.appendChild(option);
    });
    if (optionsArray.some(opt => opt && String(opt[valueField]) === String(currentValue))) { selectElement.value = currentValue; }
  }

  function getISODateString(date) { return new Date(date).toISOString().split('T')[0]; }
  function getDateRangeForFuelFilter(filterType) {
    const today=new Date(); today.setHours(0,0,0,0); let sD=new Date(today); let eD=new Date(today); eD.setHours(23,59,59,999);
    switch(filterType){ case 'today':break; case 'last7days':sD.setDate(today.getDate()-6);break; case 'last30days':sD.setDate(today.getDate()-29);break; case 'all':return{startDate:null,endDate:null}; default:return{startDate:null,endDate:null};}
    return{startDate:getISODateString(sD),endDate:getISODateString(eD)};
  }

  async function fetchFuelLogs() {
    let queryParams = `limit=${fuelLogsPerPage}&skip=${(currentFuelLogPage - 1) * fuelLogsPerPage}`;
    const vehicleFilterVal = document.getElementById('fuelVehicleFilter')?.value;
    const fuelTypeFilterVal = document.getElementById('fuelFuelTypeFilter')?.value;
    if (vehicleFilterVal) queryParams += `&vehicle_id=${vehicleFilterVal}`;
    if (fuelTypeFilterVal) queryParams += `&fuel_type_id=${fuelTypeFilterVal}`;

    if (activeFuelDateFilter !== 'all') {
        let range = (activeFuelDateFilter === 'custom' && customFuelFilterStartDate && customFuelFilterEndDate)
                    ? { startDate: customFuelFilterStartDate, endDate: customFuelFilterEndDate }
                    : getDateRangeForFuelFilter(activeFuelDateFilter);
        if (range.startDate) queryParams += `&date_after=${range.startDate}`;
        if (range.endDate) queryParams += `&date_before=${range.endDate}`;
    }

    const data = await apiRequest(`/fuel/?${queryParams}`);
    allFetchedFuelLogsFromServer = Array.isArray(data) ? data : [];
    renderFuelLogTable();
  }

  function formatDateTimeForDisplay(dateTimeStr) { if (!dateTimeStr) return 'N/A'; try { return new Date(dateTimeStr).toLocaleString(undefined, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); } catch (e) { return dateTimeStr; }}

  function renderFuelLogTable() {
    const recordsToDisplay = Array.isArray(allFetchedFuelLogsFromServer) ? allFetchedFuelLogsFromServer : [];
    const fuelLogBody = document.getElementById('fuelLogBody');
    if (!fuelLogBody) { console.error("ERROR: fuelLogBody element not found!"); return; }

    if (recordsToDisplay.length > 0) {
        fuelLogBody.innerHTML = recordsToDisplay.map(log => {
        if (typeof log !== 'object' || log === null) return '';
        const vehicle = Array.isArray(vehicleDataForDropdown_fuel) ? vehicleDataForDropdown_fuel.find(v => v.id === log.vehicle_id) : null;
        const fuelType = Array.isArray(fuelTypeDataForDropdown_fuel) ? fuelTypeDataForDropdown_fuel.find(ft => ft.id === log.fuel_type_id) : null;
        const vehicleDisplay = vehicle ? vehicle.plate_number : `VID ${log.vehicle_id || 'N/A'}`;
        const fuelTypeDisplay = fuelType ? fuelType.fuel_type : `FTID ${log.fuel_type_id || 'N/A'}`;
        return `<tr class="border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700/50" data-id="${log.id || 'unknown'}">
                    <td class="py-3 px-2">${log.id || 'N/A'}</td> <td class="px-2">${vehicleDisplay}</td> <td class="px-2">${fuelTypeDisplay}</td>
                    <td class="px-2 text-right">${(log.quantity || 0).toFixed(2)}</td> <td class="px-2 text-right">${(log.price_little || 0).toFixed(3)}</td>
                    <td class="px-2 text-right">${(log.cost || 0).toFixed(2)}</td> <td class="px-2">${formatDateTimeForDisplay(log.created_at)}</td>
                    <td class="px-2 text-center whitespace-nowrap">
                    <button onclick="openViewFuelModal(${log.id})" class="text-green-600 dark:text-green-400 p-1" title="View"><i data-lucide="eye" class="w-4 h-4"></i></button>
                    <button onclick="openEditFuelModal(${log.id})" class="text-blue-600 dark:text-blue-400 p-1 ml-1" title="Edit"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                    <button onclick="openConfirmDeleteFuelLogModal(${log.id})" class="text-red-600 dark:text-red-400 p-1 ml-1" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td></tr>`; }).join('');
    } else {
        let message = "No fuel log records found.";
        if (!getAuthToken()) message = "Please log in to view fuel logs.";
        else if (recordsToDisplay.length === 0 && !document.getElementById('fuelVehicleFilter')?.value && !document.getElementById('fuelFuelTypeFilter')?.value && activeFuelDateFilter === 'all') message = "No fuel logs recorded yet.";
        else message = "No fuel logs match your current filter criteria.";
        fuelLogBody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-500">${message}</td></tr>`;
    }
    lucide.createIcons();
    document.getElementById('fuelLogCount').textContent = `Showing ${recordsToDisplay.length} records (on current page)`;
    renderFuelLogPagination(recordsToDisplay.length);
  }

  function renderFuelLogPagination(currentPageRecordCount) {
    const paginationContainer = document.getElementById('fuelLogPagination');
    if (!paginationContainer) return;
    paginationContainer.innerHTML = '';
    const showPagination = currentFuelLogPage > 1 || currentPageRecordCount === fuelLogsPerPage ||
                           (document.getElementById('fuelVehicleFilter')?.value ||
                            document.getElementById('fuelFuelTypeFilter')?.value ||
                            activeFuelDateFilter !== 'all');

    if (!showPagination && currentPageRecordCount < fuelLogsPerPage && currentFuelLogPage === 1) return;


    const buttonClasses = "px-3 py-1.5 text-sm rounded-md transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-offset-1 dark:focus:ring-offset-gray-900 focus:ring-blue-500";
    const inactiveClasses = "bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700";
    const disabledClasses = "bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-400 dark:text-gray-500 cursor-not-allowed";

    const prevButton = document.createElement('button');
    prevButton.innerHTML = `<i data-lucide="chevron-left" class="w-4 h-4 inline-block mr-1"></i> Prev`;
    prevButton.className = `${buttonClasses} ${currentFuelLogPage === 1 ? disabledClasses : inactiveClasses}`;
    if (currentFuelLogPage > 1) prevButton.onclick = () => { currentFuelLogPage--; fetchFuelLogs(); };
    else prevButton.disabled = true;
    paginationContainer.appendChild(prevButton);

    const pageInfo = document.createElement('span');
    pageInfo.className = "px-3 py-1.5 text-sm text-gray-500 dark:text-gray-400";
    pageInfo.textContent = `Page ${currentFuelLogPage}`;
    paginationContainer.appendChild(pageInfo);

    const nextButton = document.createElement('button');
    nextButton.innerHTML = `Next <i data-lucide="chevron-right" class="w-4 h-4 inline-block ml-1"></i>`;
    const hasMore = currentPageRecordCount === fuelLogsPerPage;
    nextButton.className = `${buttonClasses} ${!hasMore ? disabledClasses : inactiveClasses}`;
    if (hasMore) nextButton.onclick = () => { currentFuelLogPage++; fetchFuelLogs(); };
    else nextButton.disabled = true;
    paginationContainer.appendChild(nextButton);
    lucide.createIcons();
  }

  async function openAddFuelModal() {
    if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in.", "error"); return; }
    fuelLogToEditId = null;
    document.getElementById('addFuelForm').reset();
    document.getElementById('fuelModalTitle').textContent = "Add New Fuel Log";
    document.getElementById('fuelSubmitButton').innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> Add Log`;
    displayDynamicCost();
    lucide.createIcons();
    document.getElementById('addFuelModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  async function openEditFuelModal(id) {
    if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in.", "error"); return; }
    const recordToEdit = await apiRequest(`/fuel/${id}`);
    if (!recordToEdit) { openInfoStatusModal("Error","Could not fetch fuel log details for editing.", "error"); return; }

    fuelLogToEditId = id;
    document.getElementById('addFuelForm').reset();
    document.getElementById('fuelModalTitle').textContent = "Edit Fuel Log";
    document.getElementById('fuelSubmitButton').innerHTML = `<i data-lucide="save" class="w-4 h-4 mr-2"></i> Save Changes`;

    document.getElementById('fuelId_form').value = recordToEdit.id;
    document.getElementById('fuel_vehicle_id_form').value = recordToEdit.vehicle_id;
    document.getElementById('fuel_fuel_type_id_form').value = recordToEdit.fuel_type_id;
    document.getElementById('fuel_quantity_form').value = recordToEdit.quantity;
    document.getElementById('fuel_price_little_form').value = recordToEdit.price_little;

    displayDynamicCost();
    lucide.createIcons();
    document.getElementById('addFuelModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  async function openViewFuelModal(id) {
    const record = await apiRequest(`/fuel/${id}`);
    if (!record) { openInfoStatusModal("Error", "Could not fetch fuel log details for viewing.", "error"); return; }

    const vehicle = Array.isArray(vehicleDataForDropdown_fuel) ? vehicleDataForDropdown_fuel.find(v => v.id === record.vehicle_id) : null;
    const fuelType = Array.isArray(fuelTypeDataForDropdown_fuel) ? fuelTypeDataForDropdown_fuel.find(ft => ft.id === record.fuel_type_id) : null;

    document.getElementById('view-fuel-id').textContent = record.id || 'N/A';
    document.getElementById('view-fuel-vehicle').textContent = vehicle ? vehicle.plate_number : `VID ${record.vehicle_id || 'N/A'}`;
    document.getElementById('view-fuel-fuel_type').textContent = fuelType ? fuelType.fuel_type : `FTID ${record.fuel_type_id || 'N/A'}`;
    document.getElementById('view-fuel-quantity').textContent = `${(record.quantity || 0).toFixed(2)} (L/kWh)`;
    document.getElementById('view-fuel-price_little').textContent = `$${(record.price_little || 0).toFixed(3)}`;
    document.getElementById('view-fuel-cost').textContent = `$${(record.cost || 0).toFixed(2)}`;
    document.getElementById('view-fuel-created_at').textContent = formatDateTimeForDisplay(record.created_at);

    document.getElementById('viewFuelModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    lucide.createIcons();
  }

  async function handleFuelFormSubmit(event) {
    event.preventDefault();
    if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in.", "error"); return; }

    const fuelData = {
      vehicle_id: parseInt(document.getElementById('fuel_vehicle_id_form').value),
      fuel_type_id: parseInt(document.getElementById('fuel_fuel_type_id_form').value),
      quantity: parseFloat(document.getElementById('fuel_quantity_form').value),
      price_little: parseFloat(document.getElementById('fuel_price_little_form').value),
    };

    if (isNaN(fuelData.vehicle_id) || isNaN(fuelData.fuel_type_id) || isNaN(fuelData.quantity) || isNaN(fuelData.price_little)) {
      openInfoStatusModal("Validation Error", "Ensure all fields (Vehicle, Fuel Type, Quantity, Price) are correctly filled.", "error"); return;
    }
    if (fuelData.quantity <= 0) { openInfoStatusModal("Validation Error", "Quantity must be greater than 0.", "error"); return;}
    if (fuelData.price_little <= 0) { openInfoStatusModal("Validation Error", "Price per Unit must be greater than 0.", "error"); return;}

    const actionType = fuelLogToEditId ? "update" : "add";
    const confirmTitle = fuelLogToEditId ? "Confirm Update" : "Confirm Add Fuel Log"; // CORRECTED
    const confirmMsg = `Are you sure you want to ${actionType} this fuel log?`; // CORRECTED
    const confirmBtnText = fuelLogToEditId ? "Update Log" : "Add Log"; // CORRECTED
    const confirmBtnIcon = fuelLogToEditId ? "save" : "plus-circle";

    openGenericConfirmModal( confirmTitle, confirmMsg, confirmBtnText, confirmBtnIcon,
        async (dataForAction) => {
            let result;
            if (fuelLogToEditId) {
                result = await apiRequest(`/fuel/${fuelLogToEditId}`, 'PUT', dataForAction);
            } else {
                result = await apiRequest('/fuel/', 'POST', dataForAction);
            }

            if (result) {
                openInfoStatusModal("Success", `Fuel log ${actionType}d successfully!`, "success"); // CORRECTED
                closeAddFuelModal();
                currentFuelLogPage = (actionType === 'add') ? 1 : currentFuelLogPage;
                await fetchFuelLogs();
            }
        },
        fuelData
    );
  }

  function openConfirmDeleteFuelLogModal(id) {
      if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in to delete.", "error"); return; }
      if (!id) { openInfoStatusModal("Error", "Cannot delete: Fuel Log ID is missing.", "error"); return; } // CORRECTED

      openGenericConfirmModal(
        "Confirm Deletion",
        `Are you sure you want to permanently delete fuel log ID: ${id}? This action cannot be undone.`, // CORRECTED
        "Delete",
        "trash-2",
        async (logIdToDelete) => {
            const result = await apiRequest(`/fuel/${logIdToDelete}`, 'DELETE');
            if (result === true) {
                openInfoStatusModal("Success", `Fuel log ID: ${logIdToDelete} deleted.`, "success"); // CORRECTED
                if(Array.isArray(allFetchedFuelLogsFromServer) && allFetchedFuelLogsFromServer.length === 1 && currentFuelLogPage > 1) {
                    currentFuelLogPage--;
                }
                await fetchFuelLogs();
            }
        },
        id
      );
  }

  function applyFuelFilters() { currentFuelLogPage = 1; fetchFuelLogs(); }
  function applyFuelDateFilter(filterType) {
    activeFuelDateFilter = filterType;
    customFuelFilterStartDate = null;
    customFuelFilterEndDate = null;
    const el = document.getElementById('fuelCustomDateRange'); if(el) el.classList.add('hidden');
    setActiveFuelDateFilterButton(filterType);
    currentFuelLogPage = 1;
    fetchFuelLogs();
  }
  function setActiveFuelDateFilterButton(filterTypeOrId) {
    document.querySelectorAll('#fuel-section .date-filter-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById(filterTypeOrId.startsWith('fuel-filter-') ? filterTypeOrId : `fuel-filter-${filterTypeOrId}`);
    if (activeBtn) activeBtn.classList.add('active');
  }
  function toggleFuelCustomDateRange() {
    const el = document.getElementById('fuelCustomDateRange');
    if(el) el.classList.toggle('hidden');
    if (el && !el.classList.contains('hidden')) setActiveFuelDateFilterButton('fuel-filter-custom-btn');
    else if (activeFuelDateFilter === 'custom') applyFuelDateFilter('all');
  }
  function applyFuelCustomDateFilter() {
    const startEl = document.getElementById('fuelCustomStartDate');
    const endEl = document.getElementById('fuelCustomEndDate');
    if(!startEl || !endEl) return;
    const startDate = startEl.value; const endDate = endEl.value;
    if (!startDate || !endDate) { openInfoStatusModal("Input Error", "Select start/end dates.", "error"); return; }
    if (new Date(startDate) > new Date(endDate)) { openInfoStatusModal("Input Error", "Start date after end date.", "error"); return; }
    activeFuelDateFilter = 'custom'; customFuelFilterStartDate = startDate; customFuelFilterEndDate = endDate;
    setActiveFuelDateFilterButton('fuel-filter-custom-btn');
    currentFuelLogPage = 1; fetchFuelLogs();
  }

  function getFuelExportData() {
    return Array.isArray(allFetchedFuelLogsFromServer) ? [...allFetchedFuelLogsFromServer] : [];
  }

  function exportFuelLogsExcel() {
    if (!getAuthToken() && getFuelExportData().length === 0) { openInfoStatusModal("Export Error", "Log in or load data.", "error"); return;}
    const records = getFuelExportData();
    if (records.length === 0) { openInfoStatusModal("Info", "No data to export.", "info"); return; }
    const wsData = records.map(log => {
        const vehicle = Array.isArray(vehicleDataForDropdown_fuel) ? vehicleDataForDropdown_fuel.find(v => v.id === log.vehicle_id) : null;
        const fuelType = Array.isArray(fuelTypeDataForDropdown_fuel) ? fuelTypeDataForDropdown_fuel.find(ft => ft.id === log.fuel_type_id) : null;
        return { 'ID': log.id, 'Vehicle Plate': vehicle ? vehicle.plate_number : `ID ${log.vehicle_id}`, 'Fuel Type': fuelType ? fuelType.fuel_type : `ID ${log.fuel_type_id}`,
            'Quantity': (log.quantity || 0).toFixed(2), 'Price/Unit ($)': (log.price_little || 0).toFixed(3), 'Total Cost ($)': (log.cost || 0).toFixed(2),
            'Date Recorded': formatDateTimeForDisplay(log.created_at) };
    });
    const ws = XLSX.utils.json_to_sheet(wsData); const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "FuelLogs"); XLSX.writeFile(wb, "fuel_logs_export.xlsx");
  }

  function exportFuelLogsPDF() {
    if (!getAuthToken() && getFuelExportData().length === 0) { openInfoStatusModal("Export Error", "Log in or load data.", "error"); return;}
    const {jsPDF} = window.jspdf; const doc = new jsPDF();
    doc.setFontSize(18); doc.text('Fuel Log Records', 14, 15);
    const records = getFuelExportData();
    if (records.length === 0) { openInfoStatusModal("Info", "No data to export.", "info"); return; }

    const headers = [['ID', 'Vehicle', 'Fuel Type', 'Qty', 'Price/Unit', 'Total Cost', 'Date']];
    const data = records.map(log => {
        const vehicle = Array.isArray(vehicleDataForDropdown_fuel) ? vehicleDataForDropdown_fuel.find(v => v.id === log.vehicle_id) : null;
        const fuelType = Array.isArray(fuelTypeDataForDropdown_fuel) ? fuelTypeDataForDropdown_fuel.find(ft => ft.id === log.fuel_type_id) : null;
        return [ log.id, vehicle ? vehicle.plate_number : `ID ${log.vehicle_id}`, fuelType ? fuelType.fuel_type : `ID ${log.fuel_type_id}`,
            (log.quantity || 0).toFixed(2), `$${(log.price_little || 0).toFixed(3)}`, `$${(log.cost || 0).toFixed(2)}`,
            new Date(log.created_at).toLocaleDateString() ];
    });
    doc.autoTable({ head: headers, body: data, startY: 25, theme:'grid',
        columnStyles: {
            0: { cellWidth: 10, halign: 'right' }, 1: { cellWidth: 30 }, 2: {cellWidth: 30},
            3:{cellWidth:20, halign: 'right'}, 4:{cellWidth:25, halign: 'right'},
            5:{cellWidth:25, halign: 'right'}, 6:{cellWidth:25}
        }
    });
    doc.save('fuel_logs_export.pdf');
  }

</script>
</body>
</html>