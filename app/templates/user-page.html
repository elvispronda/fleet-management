<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - User Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <style>
    .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
    .modal.hidden { visibility: hidden; opacity: 0; }
    .modal:not(.hidden) { visibility: visible; opacity: 1; }
    .dark .modal-content { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5), 0 10px 10px -5px rgba(0,0,0,0.2); }
    .date-filter-btn.active { background-color: #3b82f6; color: white; }
    .dark .date-filter-btn.active { background-color: #60a5fa; }
    .view-detail-label { font-weight: 500; color: #4b5563; }
    .dark .view-detail-label { color: #d1d5db; }
    .view-detail-value { color: #1f2937; }
    .dark .view-detail-value { color: #f9fafb; }
    /* Ensure loading overlay is defined or copied from previous examples if needed */
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); color: white; display: flex; justify-content: center; align-items: center; z-index: 1000; font-size: 2em; visibility: hidden; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white">

<!-- 
  YOUR FULL HTML STRUCTURE FOR THE USER MANAGEMENT PAGE GOES HERE
  This includes the sidebar, main content area with the table placeholder, modals, etc.
  Crucially, ensure these IDs are present in your HTML:
  - currentUserDisplayUsername (in the sidebar)
  - currentUserRoleDisplay (in the sidebar, optional)
  - usersTable
  - usersBody (inside usersTable)
  - usersCount
  - usersPagination
  - addUserModal and its form elements
  - viewUserModal and its display elements
  - confirmDeleteUserModal
  - loading-overlay (style for it is above)
-->
<div class="flex flex-col md:flex-row h-screen overflow-hidden">

    <!-- Sidebar (Left) - MAKE SURE THIS HTML IS PRESENT -->
    <aside class="w-64 bg-white dark:bg-gray-800/95 backdrop-blur-sm p-4 space-y-6 shadow-lg hidden md:block flex-shrink-0 border-r dark:border-gray-700">
      <div class="text-2xl font-bold flex items-center space-x-2 text-primary dark:text-primary-light">
        <i data-lucide="command" class="w-7 h-7"></i><span>FleetDash</span>
      </div>
      <nav class="flex-1">
        <ul class="space-y-2">
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i><a href="dashboard.html">Dashboard</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="pie-chart" class="w-5 h-5"></i><a href="analytics.html">Analytics</a>
        </li>
        <li class="flex items-center space-x-3 text-blue-600 dark:text-blue-400 font-semibold bg-blue-50 dark:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="users" class="w-5 h-5"></i><a href="/user/users-page">User</a> <!-- Corrected link -->
        </li>
        <!-- ... other sidebar links ... -->
      </ul>
      </nav>
       <div class="pt-4 border-t border-gray-200 dark:border-gray-700/50 mt-auto">
            <a href="#" id="global-logout-btn" class="flex items-center space-x-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/40 p-2.5 rounded-lg transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i><span>Logout</span>
            </a>
       </div>
    </aside>
    
  <!-- Main content - MAKE SURE THIS HTML IS PRESENT -->
  <main class="flex-1 overflow-auto p-6">
    <section id="user-section" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow mb-6">
      <!-- ... Add User button, Search, Export buttons ... -->
       <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
        <div class="flex flex-wrap gap-2 items-center">
          <button onclick="openAddUserModal()" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-1 text-sm shadow-sm">
            <i data-lucide="user-plus" class="w-4 h-4"></i> Add User
          </button>
          <input type="text" id="userSearch" placeholder="Search users (email)..." class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm text-black dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-auto">
        </div>
        <div class="flex flex-wrap gap-2 items-center">
          <button onclick="exportUsersExcel()" class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 text-sm shadow-sm">ðŸ“„ Excel</button>
          <button onclick="exportUsersPDF()" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm shadow-sm">ðŸ§¾ PDF</button>
        </div>
      </div>
      <!-- ... Date Filters ... -->
       <div class="mb-4 flex flex-wrap items-center gap-2">
        <span class="text-sm font-medium mr-2">Filter Users by Creation Date:</span>
        <button id="user-filter-today" onclick="applyUserDateFilter('today')" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Today</button>
        <button id="user-filter-last7" onclick="applyUserDateFilter('last7days')" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Last 7 Days</button>
        <button id="user-filter-last30" onclick="applyUserDateFilter('last30days')" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Last 30 Days</button>
        <button id="user-filter-all" onclick="applyUserDateFilter('all')" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 active">All Time</button>
        <button id="user-filter-custom-btn" onclick="toggleUserCustomDateRange()" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Custom Range</button>
      </div>
      <div id="userCustomDateRange" class="mb-4 hidden items-center gap-2 p-3 border dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-800/50">
        <input type="date" id="userCustomStartDate" class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
        <span class="text-sm">to</span>
        <input type="date" id="userCustomEndDate" class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
        <button onclick="applyUserCustomDateFilter()" class="bg-blue-500 text-white px-3 py-1.5 text-sm rounded-md hover:bg-blue-600">Apply</button>
      </div>

      <div class="overflow-x-auto">
        <table id="usersTable" class="w-full text-left text-sm">
          <thead>
            <tr class="border-b dark:border-gray-700">
              <th class="py-3 px-2 font-semibold">ID</th>
              <th class="px-2 font-semibold">Username</th>
              <th class="px-2 font-semibold">Email</th>
              <th class="px-2 font-semibold">Status</th>
              <th class="px-2 font-semibold">Created At</th>
              <th class="px-2 font-semibold text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="usersBody"></tbody> <!-- Table body placeholder -->
        </table>
      </div>
      <div class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
        <div class="text-sm text-gray-600 dark:text-gray-400" id="usersCount"></div>
        <div class="flex items-center space-x-1" id="usersPagination"></div>
      </div>
    </section>
  </main>

    <!-- Right Sidebar - MAKE SURE THIS HTML IS PRESENT AND CONTAINS THE IDs -->
    <aside class="w-1/5 bg-white dark:bg-gray-800 p-4 space-y-6 shadow-md hidden lg:block flex-shrink-0">
        <div class="flex justify-between items-center">
        <button id="theme-toggle" class="text-xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">ðŸŒ™</button>
        <div>
            <div class="text-sm font-semibold" id="currentUserDisplayUsername">User</div> <!-- ID needed by JS -->
            <div class="text-xs text-gray-500 dark:text-gray-300" id="currentUserRoleDisplay">Role</div> <!-- ID needed by JS -->
        </div>
        </div>
        <!-- ... other right sidebar content ... -->
    </aside>
</div>

<!-- MODALS - MAKE SURE ALL MODAL HTML IS PRESENT -->
<!-- Add/Edit User Modal -->
<div id="addUserModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="userModalTitle">Add New User</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400">Fill in the user details below</p>
        </div>
        <button onclick="closeAddUserModal()" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <form id="addUserForm" class="space-y-4">
        <input type="hidden" id="userId_form"> 
        <div>
          <label for="user_username_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>
          <input type="text" id="user_username_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="e.g., johndoe">
        </div>
        <div>
          <label for="user_email_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
          <input type="email" id="user_email_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="user@example.com">
        </div>
        <div>
          <label for="user_password_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
          <input type="password" id="user_password_form" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="Enter new password (required for new users)">
          <p id="passwordHint" class="text-xs text-gray-500 dark:text-gray-400 mt-1 hidden">Leave blank to keep current password.</p>
        </div>
         <div>
          <label for="user_status_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
          <select id="user_status_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
            <!-- Options populated by JS -->
          </select>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeAddUserModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
          <button type="submit" id="userSubmitButton" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
            <i data-lucide="plus-circle" class="w-4 h-4"></i> Add User
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- View User Record Modal -->
<div id="viewUserModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white">User Details</h3>
        <button onclick="closeViewUserModal()" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <div id="viewUserDetails" class="space-y-3 text-sm">
        <div class="grid grid-cols-3 gap-x-4"><span class="view-detail-label col-span-1">User ID:</span><span id="view-user-id" class="view-detail-value col-span-2"></span></div>
        <div class="grid grid-cols-3 gap-x-4"><span class="view-detail-label col-span-1">Username:</span><span id="view-user-username" class="view-detail-value col-span-2"></span></div>
        <div class="grid grid-cols-3 gap-x-4"><span class="view-detail-label col-span-1">Email:</span><span id="view-user-email" class="view-detail-value col-span-2"></span></div>
        <div class="grid grid-cols-3 gap-x-4"><span class="view-detail-label col-span-1">Status:</span><span id="view-user-status" class="view-detail-value col-span-2"></span></div>
        <div class="grid grid-cols-3 gap-x-4"><span class="view-detail-label col-span-1">Created At:</span><span id="view-user-created_at" class="view-detail-value col-span-2"></span></div>
      </div>
      <div class="flex justify-end pt-6">
          <button type="button" onclick="closeViewUserModal()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg">Close</button>
      </div>
    </div>
  </div>
</div>
<!-- Confirmation Modal for User Deletion -->
<div id="confirmDeleteUserModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <div><h3 class="text-xl font-bold text-gray-800 dark:text-white">Confirm Deletion</h3><p class="text-sm text-gray-500 dark:text-gray-400">Are you sure you want to delete this user?</p></div>
        <button onclick="closeConfirmDeleteUserModal()" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i></button>
      </div>
      <div class="flex justify-end gap-3 pt-4">
        <button onclick="closeConfirmDeleteUserModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
        <button id="confirmDeleteUserBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg flex items-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i> Delete</button>
      </div>
    </div>
  </div>
</div>
<div id="loading-overlay">Loading...</div> <!-- Loading overlay -->


<script>
  // --- Global Variables for User ---
  let allFetchedUsers = []; 
  const usersPerPage = 5; 
  let currentUserPage = 1;
  let userToEditId = null; 
  let userToDeleteId = null;
  let activeUserDateFilter = 'all'; 
  let customUserFilterStartDate = null; 
  let customUserFilterEndDate = null;
  
  const mockUserStatuses = ["active", "inactive", "pending_approval", "suspended"]; 
  const API_BASE_URL = "/user"; // API calls will go to /user/...
  // Adjust this if your login page HTML file is served from a different path
  const LOGIN_PAGE_URL = "/login.html"; 

  console.log("USERS PAGE: Script started. Checking localStorage for authToken...");
  const initialTokenCheckUsersPage = localStorage.getItem('authToken');
  console.log("USERS PAGE: Initial authToken from localStorage:", initialTokenCheckUsersPage);

  // No immediate redirect from here if token is missing; getAuthToken() will handle it.

  // --- Authentication: Token Retrieval ---
  function getAuthToken() {
    // --- STANDARDIZED TOKEN KEY ---
    const token = localStorage.getItem('authToken'); 
    console.log("USERS PAGE: getAuthToken() called. Token from localStorage:", token);
    if (!token) {
      alert("Authentication token not found. Please log in.");
      window.location.href = LOGIN_PAGE_URL; 
      throw new Error("Auth token not found, redirecting to login."); 
    }
    return token;
  }

  // --- API Request Helper ---
  async function makeApiRequest(url, method = 'GET', body = null) {
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) loadingOverlay.style.visibility = 'visible';
    
    const headers = { 'Content-Type': 'application/json' };
    let token;
    try {
        token = getAuthToken(); 
    } catch (error) {
        if (loadingOverlay) loadingOverlay.style.visibility = 'hidden';
        throw error; 
    }
    
    headers['Authorization'] = `Bearer ${token}`;
    const config = { method: method, headers: headers };
    if (body && (method === 'POST' || method === 'PUT')) {
      config.body = JSON.stringify(body);
    }

    try {
      const response = await fetch(url, config);
      if (loadingOverlay) loadingOverlay.style.visibility = 'hidden'; // Hide on response

      if (response.status === 204) return null;
      
      const data = await response.json();
      if (!response.ok) {
        const errorDetail = data.detail || JSON.stringify(data);
        console.error('USERS PAGE: API Error:', response.status, errorDetail);
        if (response.status === 401) { 
            alert(`Authentication failed or token expired: ${errorDetail}. Redirecting to login.`);
            localStorage.removeItem('authToken'); 
            localStorage.removeItem('username');
            window.location.href = LOGIN_PAGE_URL;
        } else {
            alert(`API Error: ${errorDetail}`);
        }
        throw new Error(errorDetail);
      }
      return data;
    } catch (error) {
      if (loadingOverlay) loadingOverlay.style.visibility = 'hidden'; // Hide on error
      console.error(`USERS PAGE: API request to ${url} failed:`, error);
      if (!error.message.startsWith("API Error:") && !error.message.startsWith("Auth token not found")) { 
          alert(`Request failed: ${error.message}`);
      }
      throw error;
    }
  }
  
  // --- DOMContentLoaded ---
  document.addEventListener('DOMContentLoaded', () => {
      console.log("USERS PAGE: DOMContentLoaded event fired.");
      
      const storedUsername = localStorage.getItem('username');
      console.log("USERS PAGE: Username from localStorage on DOMContentLoaded:", storedUsername);
      
      const usernameDisplay = document.getElementById('currentUserDisplayUsername');
      const roleDisplay = document.getElementById('currentUserRoleDisplay'); 

      if (usernameDisplay) {
          usernameDisplay.textContent = storedUsername || "User";
      } else {
          console.warn("USERS PAGE: currentUserDisplayUsername element not found in DOM.");
      }
      if (roleDisplay) {
          roleDisplay.textContent = "Admin"; // Or fetch actual role
      } else {
          console.warn("USERS PAGE: currentUserRoleDisplay element not found in DOM.");
      }
      
      try {
        initializeUserSection();
      } catch (error) {
        console.log("USERS PAGE: Initialization halted due to auth token issue. Error:", error.message);
        // Redirection is handled by getAuthToken if it was an auth issue
        return; 
      }
      
      lucide.createIcons(); 
      const themeToggleButton = document.getElementById('theme-toggle');
      if (themeToggleButton) themeToggleButton.addEventListener('click', () => document.documentElement.classList.toggle('dark'));
      else console.warn("USERS PAGE: theme-toggle button not found.");
      
      // Modal event listeners (ensure modal IDs exist in your HTML)
      const addUserModalEl = document.getElementById('addUserModal');
      if (addUserModalEl) addUserModalEl.addEventListener('click', e => { if (e.target === e.currentTarget) closeAddUserModal(); });
      else console.warn("USERS PAGE: addUserModal element not found.");

      const viewUserModalEl = document.getElementById('viewUserModal');
      if (viewUserModalEl) viewUserModalEl.addEventListener('click', e => { if (e.target === e.currentTarget) closeViewUserModal(); });
      else console.warn("USERS PAGE: viewUserModal element not found.");
      
      const confirmDeleteUserModalEl = document.getElementById('confirmDeleteUserModal');
      if (confirmDeleteUserModalEl) confirmDeleteUserModalEl.addEventListener('click', e => { if (e.target === e.currentTarget) closeConfirmDeleteUserModal(); });
      else console.warn("USERS PAGE: confirmDeleteUserModal element not found.");
      
      const logoutButton = document.getElementById('global-logout-btn');
      if (logoutButton) {
          logoutButton.addEventListener('click', (e) => {
              e.preventDefault();
              console.log("USERS PAGE: Logout button clicked.");
              localStorage.removeItem('authToken');
              localStorage.removeItem('username'); 
              alert("You have been logged out.");
              window.location.href = LOGIN_PAGE_URL; 
          });
      } else {
          console.warn("USERS PAGE: global-logout-btn not found.");
      }
  });

  function getISODateString(date) { return date.toISOString().split('T')[0]; }
  function getDateRange(filterType) {
    const today=new Date(); today.setHours(0,0,0,0); let sD=new Date(today); let eD=new Date(today); eD.setHours(23,59,59,999);
    switch(filterType){ case 'today':break; case 'last7days':sD.setDate(today.getDate()-6);break; case 'last30days':sD.setDate(today.getDate()-29);break; case 'all':return{startDate:null,endDate:null}; default:return{startDate:null,endDate:null};}
    return{startDate:getISODateString(sD),endDate:getISODateString(eD)};
  }

  function initializeUserSection() {
    console.log("USERS PAGE: initializeUserSection called.");
    fetchUsers(); 
    populateUserDropdowns(); // This uses mock data, ensure 'user_status_form' exists

    const userSearchEl = document.getElementById('userSearch');
    if (userSearchEl) {
        userSearchEl.addEventListener('input', () => { 
            currentUserPage = 1; 
            fetchUsers(); 
        });
    } else console.warn("USERS PAGE: userSearch element not found.");


    const addUserFormEl = document.getElementById('addUserForm');
    if (addUserFormEl) addUserFormEl.addEventListener('submit', handleUserFormSubmit);
    else console.warn("USERS PAGE: addUserForm element not found.");

    const confirmDeleteUserBtnEl = document.getElementById('confirmDeleteUserBtn');
    if (confirmDeleteUserBtnEl) confirmDeleteUserBtnEl.addEventListener('click', confirmDeleteUser);
    else console.warn("USERS PAGE: confirmDeleteUserBtn element not found.");
    
    setActiveUserDateFilterButton('all');
  }

  async function fetchUsers() {
    console.log("USERS PAGE: fetchUsers called.");
    const userSearchEl = document.getElementById('userSearch');
    const searchTerm = userSearchEl ? userSearchEl.value : "";
    
    // API_BASE_URL is /user, so this becomes /user/?limit=1000
    let url = `${API_BASE_URL}/?limit=5`; 
    if (searchTerm) {
        url += `&search=${encodeURIComponent(searchTerm)}`;
    }
    try {
        console.log("USERS PAGE: fetchUsers: About to call makeApiRequest for URL:", url);
        const usersData = await makeApiRequest(url); 
        console.log("USERS PAGE: fetchUsers: Data received from API:", usersData);

        if (!usersData || !Array.isArray(usersData)) {
            console.warn("USERS PAGE: fetchUsers: API did not return a valid array. Received:", usersData);
            allFetchedUsers = [];
        } else {
             allFetchedUsers = usersData.map(user => ({
                ...user,
                created_at: user.created_at ? String(user.created_at) : null
            }));
            console.log("USERS PAGE: fetchUsers: Processed allFetchedUsers:", allFetchedUsers);
        }
        currentUserPage = 1; 
        renderUsersTable();
    } catch (error) {
        console.error("USERS PAGE: Error during fetchUsers (error likely handled by makeApiRequest):", error.message);
        if (document.getElementById('usersBody')) { 
            allFetchedUsers = [];
            renderUsersTable(); 
        }
    }
  }

  function applyUserDateFilter(filterType) {
    activeUserDateFilter = filterType; customUserFilterStartDate = null; customUserFilterEndDate = null;
    const customDateRangeEl = document.getElementById('userCustomDateRange');
    if(customDateRangeEl) customDateRangeEl.classList.add('hidden');
    else console.warn("USERS PAGE: userCustomDateRange element not found for date filter.");
    setActiveUserDateFilterButton(filterType); currentUserPage = 1; renderUsersTable();
  }
  function toggleUserCustomDateRange() {
    const customDateRangeEl = document.getElementById('userCustomDateRange');
    if (!customDateRangeEl) {
        console.warn("USERS PAGE: userCustomDateRange element not found for toggle.");
        return;
    }
    customDateRangeEl.classList.toggle('hidden');
    if (!customDateRangeEl.classList.contains('hidden')) setActiveUserDateFilterButton('user-filter-custom-btn');
    else if (activeUserDateFilter === 'custom') applyUserDateFilter('all');
  }
  function applyUserCustomDateFilter() {
    const sDEl = document.getElementById('userCustomStartDate');
    const eDEl = document.getElementById('userCustomEndDate');
    if (!sDEl || !eDEl) {
        console.warn("USERS PAGE: Custom date input elements not found.");
        return;
    }
    const sD = sDEl.value, eD = eDEl.value;
    if (!sD || !eD) { alert("Please select both start and end dates for User Records."); return; }
    if (new Date(sD) > new Date(eD)) { alert("Start date cannot be after end date for User Records."); return; }
    activeUserDateFilter = 'custom'; customUserFilterStartDate = sD; customUserFilterEndDate = eD;
    setActiveUserDateFilterButton('user-filter-custom-btn'); currentUserPage = 1; renderUsersTable();
  }
  function setActiveUserDateFilterButton(filterId) {
    document.querySelectorAll('#user-section .date-filter-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById(filterId.startsWith('user-filter-') ? filterId : `user-filter-${filterId}`);
    if (activeBtn) activeBtn.classList.add('active');
    else console.warn(`USERS PAGE: Date filter button with ID '${filterId}' or 'user-filter-${filterId}' not found.`);
  }

  async function populateUserDropdowns() {
    const statusSelect = document.getElementById('user_status_form');
    if (!statusSelect) {
        console.warn("USERS PAGE: user_status_form select element not found for populating.");
        return;
    }
    statusSelect.innerHTML = ''; 
    mockUserStatuses.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s.charAt(0).toUpperCase() + s.slice(1).replace(/_/g, ' '); statusSelect.appendChild(o); });
  }

  function renderUsersTable() {
    console.log("USERS PAGE: renderUsersTable called. allFetchedUsers to render:", allFetchedUsers);
    if (!Array.isArray(allFetchedUsers)) {
        console.error("USERS PAGE: renderUsersTable: allFetchedUsers is not an array! Value:", allFetchedUsers);
        allFetchedUsers = []; 
    }

    let recordsToDisplay = [...allFetchedUsers];
    // console.log("USERS PAGE: renderUsersTable: Initial recordsToDisplay:", recordsToDisplay);

    if (activeUserDateFilter !== 'all') {
      let range = (activeUserDateFilter === 'custom' && customUserFilterStartDate && customUserFilterEndDate) ? 
                  { startDate: customUserFilterStartDate, endDate: customUserFilterEndDate } : 
                  getDateRange(activeUserDateFilter);
      if (range.startDate && range.endDate) {
        recordsToDisplay = recordsToDisplay.filter(r => {
          if (!r.created_at) return false; 
          try {
            const recordCreationDate = getISODateString(new Date(r.created_at)); 
            return recordCreationDate >= range.startDate && recordCreationDate <= range.endDate;
          } catch (e) {
            console.warn("USERS PAGE: Error parsing created_at for date filter:", r.created_at, e);
            return false;
          }
        });
      }
    }
    // console.log("USERS PAGE: renderUsersTable: recordsToDisplay after date filter:", recordsToDisplay);

    const start = (currentUserPage - 1) * usersPerPage;
    const paginatedRecords = recordsToDisplay.slice(start, start + usersPerPage);
    // console.log("USERS PAGE: renderUsersTable: paginatedRecords:", paginatedRecords);

    const usersBody = document.getElementById('usersBody');
    if (!usersBody) {
        console.warn("USERS PAGE: renderUsersTable: usersBody element not found.");
        return;
    }
    usersBody.innerHTML = paginatedRecords.length > 0 ? paginatedRecords.map(r => {
      const statusDisplay = r.status ? String(r.status).replace(/_/g, ' ') : 'N/A';
      const statusColor = r.status === "active" ? "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200" : 
                          r.status === "inactive" ? "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200" :
                          r.status === "pending_approval" ? "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200" :
                          r.status === "suspended" ? "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200" :
                          "bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200";
      let createdAtDisplay = 'N/A';
      if (r.created_at) {
        try {
            createdAtDisplay = new Date(r.created_at).toLocaleString();
            if (createdAtDisplay === "Invalid Date") {
                console.warn("USERS PAGE: Invalid date format for created_at for user ID", r.id, "Value:", r.created_at);
                createdAtDisplay = String(r.created_at); // Show raw value if parsing fails
            }
        } catch (e) {
            console.warn("USERS PAGE: Error creating date object for created_at:", r.created_at, e);
            createdAtDisplay = String(r.created_at);
        }
      }

      return `<tr class="border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors" data-id="${r.id || ''}">
                <td class="py-3 px-2">${r.id || 'N/A'}</td>
                <td class="px-2">${r.username || 'N/A'}</td>
                <td class="px-2">${r.email || 'N/A'}</td>
                <td class="px-2"><span class="px-2 py-1 text-xs rounded-full ${statusColor}">${statusDisplay}</span></td>
                <td class="px-2">${createdAtDisplay}</td>
                <td class="px-2 text-center whitespace-nowrap">
                  <button onclick="openViewUserModal(${r.id || null})" class="text-green-600 dark:text-green-400 hover:underline p-1" title="View Details"><i data-lucide="eye" class="w-4 h-4 inline-block"></i></button>
                  <button onclick="openEditUserModal(${r.id || null})" class="text-blue-600 dark:text-blue-400 hover:underline p-1 ml-1" title="Edit Record"><i data-lucide="edit-2" class="w-4 h-4 inline-block"></i></button>
                  <button onclick="openConfirmDeleteUserModal(${r.id || null})" class="text-red-600 dark:text-red-400 hover:underline p-1 ml-1" title="Delete Record"><i data-lucide="trash-2" class="w-4 h-4 inline-block"></i></button>
                </td></tr>`;
    }).join('') : `<tr><td colspan="6" class="text-center py-8 text-gray-500">No user records found.</td></tr>`;
    
    if (typeof lucide !== 'undefined' && lucide.createIcons) {
        lucide.createIcons();
    } else {
        console.warn("USERS PAGE: Lucide library not available for createIcons.");
    }

    const usersCountEl = document.getElementById('usersCount');
    if (usersCountEl) usersCountEl.textContent = `Showing ${paginatedRecords.length > 0 ? start + 1 : 0} to ${Math.min(start + usersPerPage, recordsToDisplay.length)} of ${recordsToDisplay.length} records`;
    else console.warn("USERS PAGE: usersCount element not found.");

    renderUserPagination(recordsToDisplay.length);
    // console.log("USERS PAGE: renderUsersTable: Finished rendering.");
  }

  function renderUserPagination(totalRecords) { 
    const tP=Math.ceil(totalRecords/usersPerPage);
    const pC=document.getElementById('usersPagination');
    if (!pC) {
        console.warn("USERS PAGE: usersPagination element not found.");
        return;
    }
    pC.innerHTML='';if(tP<=1)return;
    const bCls="px-3 py-1.5 text-sm rounded-md transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-offset-1 dark:focus:ring-offset-gray-900 focus:ring-blue-500";const iCls="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700";const aCls="bg-blue-500 text-white border border-blue-500 hover:bg-blue-600";const dCls="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-400 dark:text-gray-500 cursor-not-allowed";
    const pB=document.createElement('button');pB.innerHTML=`<i data-lucide="chevron-left" class="w-4 h-4 inline-block mr-1"></i> Prev`;pB.className=`${bCls} ${currentUserPage===1?dCls:iCls}`;if(currentUserPage>1)pB.onclick=()=>{currentUserPage--;renderUsersTable();};else pB.disabled=true;pC.appendChild(pB);
    const pgs=[];if(tP<=5){for(let i=1;i<=tP;i++)pgs.push(i);}else{pgs.push(1);if(currentUserPage>3)pgs.push('...');for(let i=Math.max(2,currentUserPage-1);i<=Math.min(tP-1,currentUserPage+1);i++)if(!pgs.includes(i))pgs.push(i);if(currentUserPage<tP-2)pgs.push('...');if(!pgs.includes(tP))pgs.push(tP);}
    pgs.forEach(pN=>{if(pN==='...'){const el=document.createElement('span');el.textContent='...';el.className="px-3 py-1.5 text-sm text-gray-500 dark:text-gray-400";pC.appendChild(el);}else{const pBtn=document.createElement('button');pBtn.textContent=pN;pBtn.className=`${bCls} ${pN===currentUserPage?aCls:iCls}`;pBtn.onclick=()=>{currentUserPage=pN;renderUsersTable();};pC.appendChild(pBtn);}});
    const nB=document.createElement('button');nB.innerHTML=`Next <i data-lucide="chevron-right" class="w-4 h-4 inline-block ml-1"></i>`;nB.className=`${bCls} ${currentUserPage===tP?dCls:iCls}`;if(currentUserPage<tP)nB.onclick=()=>{currentUserPage++;renderUsersTable();};else nB.disabled=true;pC.appendChild(nB);
    if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
  }
  
  function openAddUserModal() {
    const addUserModalEl = document.getElementById('addUserModal');
    const addUserFormEl = document.getElementById('addUserForm');
    const userModalTitleEl = document.getElementById('userModalTitle');
    const userSubmitButtonEl = document.getElementById('userSubmitButton');
    const userPasswordFormEl = document.getElementById('user_password_form');
    const passwordHintEl = document.getElementById('passwordHint');

    if (!addUserModalEl || !addUserFormEl || !userModalTitleEl || !userSubmitButtonEl || !userPasswordFormEl || !passwordHintEl) {
        console.error("USERS PAGE: One or more elements for Add User Modal not found."); return;
    }
    userToEditId = null; addUserFormEl.reset();
    userModalTitleEl.textContent = "Add New User";
    userSubmitButtonEl.innerHTML = `<i data-lucide="user-plus" class="w-4 h-4"></i> Add User`;
    userPasswordFormEl.required = true;
    passwordHintEl.classList.add('hidden');
    populateUserDropdowns(); 
    if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
    addUserModalEl.classList.remove('hidden'); document.body.style.overflow = 'hidden';
  }

  async function openEditUserModal(id) {
    if (id === null) { console.warn("USERS PAGE: openEditUserModal called with null ID."); return; }
    const r = allFetchedUsers.find(rec => rec.id === id); 
    if (!r) { alert("User not found! The list might be outdated. Please refresh."); return; }
    
    const addUserModalEl = document.getElementById('addUserModal');
    const addUserFormEl = document.getElementById('addUserForm');
    const userModalTitleEl = document.getElementById('userModalTitle');
    const userSubmitButtonEl = document.getElementById('userSubmitButton');
    const userIdFormEl = document.getElementById('userId_form');
    const usernameFormEl = document.getElementById('user_username_form');
    const emailFormEl = document.getElementById('user_email_form');
    const passwordFormEl = document.getElementById('user_password_form');
    const passwordHintEl = document.getElementById('passwordHint');
    const statusFormEl = document.getElementById('user_status_form');

    if (!addUserModalEl || !addUserFormEl || !userModalTitleEl || !userSubmitButtonEl || !userIdFormEl || !usernameFormEl || !emailFormEl || !passwordFormEl || !passwordHintEl || !statusFormEl) {
        console.error("USERS PAGE: One or more elements for Edit User Modal not found."); return;
    }

    userToEditId = id; 
    addUserFormEl.reset(); 
    userModalTitleEl.textContent = "Edit User";
    userSubmitButtonEl.innerHTML = `<i data-lucide="save" class="w-4 h-4"></i> Save Changes`;
    
    await populateUserDropdowns(); 
    
    userIdFormEl.value = r.id; 
    usernameFormEl.value = r.username || '';
    emailFormEl.value = r.email || '';
    passwordFormEl.value = ""; 
    passwordFormEl.required = false; 
    passwordHintEl.classList.remove('hidden');
    if (r.status) statusFormEl.value = r.status;
    
    if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
    addUserModalEl.classList.remove('hidden'); document.body.style.overflow = 'hidden';
  }
  function closeAddUserModal() { 
    const addUserModalEl = document.getElementById('addUserModal');
    if (addUserModalEl) addUserModalEl.classList.add('hidden');
    document.body.style.overflow = ''; userToEditId = null; 
  }

  function openViewUserModal(id) {
    if (id === null) { console.warn("USERS PAGE: openViewUserModal called with null ID."); return; }
    const r = allFetchedUsers.find(rec => rec.id === id); 
    if (!r) { alert("User not found! The list might be outdated. Please refresh."); return; }

    const viewUserModalEl = document.getElementById('viewUserModal');
    if (!viewUserModalEl) { console.error("USERS PAGE: viewUserModal element not found."); return; }

    const viewIdEl = document.getElementById('view-user-id');
    const viewUsernameEl = document.getElementById('view-user-username');
    const viewEmailEl = document.getElementById('view-user-email');
    const viewStatusEl = document.getElementById('view-user-status');
    const viewCreatedAtEl = document.getElementById('view-user-created_at');

    if(viewIdEl) viewIdEl.textContent = r.id;
    if(viewUsernameEl) viewUsernameEl.textContent = r.username || 'N/A';
    if(viewEmailEl) viewEmailEl.textContent = r.email || 'N/A';
    if(viewStatusEl) viewStatusEl.textContent = r.status ? r.status.replace(/_/g, ' ') : 'N/A';
    if(viewCreatedAtEl) viewCreatedAtEl.textContent = r.created_at ? new Date(r.created_at).toLocaleString() : 'N/A';
    
    viewUserModalEl.classList.remove('hidden'); document.body.style.overflow = 'hidden'; 
    if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
  }
  function closeViewUserModal() { 
    const viewUserModalEl = document.getElementById('viewUserModal');
    if(viewUserModalEl) viewUserModalEl.classList.add('hidden');
    document.body.style.overflow = ''; 
  }

  async function handleUserFormSubmit(event) {
    event.preventDefault();
    const passwordFormEl = document.getElementById('user_password_form');
    const usernameFormEl = document.getElementById('user_username_form');
    const emailFormEl = document.getElementById('user_email_form');
    const statusFormEl = document.getElementById('user_status_form');

    if(!passwordFormEl || !usernameFormEl || !emailFormEl || !statusFormEl){
        console.error("USERS PAGE: Form elements for submission not found."); return;
    }

    const password = passwordFormEl.value;
    const userData = {
      username: usernameFormEl.value,
      email: emailFormEl.value,
      status: statusFormEl.value 
    };

    if (!userToEditId) { 
        if (!password) { alert("Password is required for new users."); return; }
        userData.password = password;
    } else if (password) { 
        userData.password = password;
    }
    
    if (!userData.username || !userData.email || !userData.status) {
      alert("Please fill all required User fields: Username, Email, Status."); return;
    }
    
    try {
        if (userToEditId) {
            await makeApiRequest(`${API_BASE_URL}/${userToEditId}`, 'PUT', userData);
            alert('User record updated successfully!');
        } else {
            await makeApiRequest(`${API_BASE_URL}/`, 'POST', userData);
            alert('User record added successfully!');
        }
        closeAddUserModal();
        fetchUsers(); 
    } catch (error) {
        console.error("USERS PAGE: Error in handleUserFormSubmit (error likely handled):", error.message);
    }
  }

  function openConfirmDeleteUserModal(id) { 
    if (id === null) { console.warn("USERS PAGE: openConfirmDeleteUserModal called with null ID."); return; }
    userToDeleteId = id; 
    const modalEl = document.getElementById('confirmDeleteUserModal');
    if(modalEl) modalEl.classList.remove('hidden');
    else console.error("USERS PAGE: confirmDeleteUserModal element not found.");
    document.body.style.overflow = 'hidden'; 
  }
  function closeConfirmDeleteUserModal() { 
    userToDeleteId = null; 
    const modalEl = document.getElementById('confirmDeleteUserModal');
    if(modalEl) modalEl.classList.add('hidden');
    document.body.style.overflow = ''; 
  }
  
  async function confirmDeleteUser() {
    if (!userToDeleteId) return;
    try {
        await makeApiRequest(`${API_BASE_URL}/${userToDeleteId}`, 'DELETE');
        alert('User record deleted successfully!');
        closeConfirmDeleteUserModal();
        
        const usersBodyEl = document.getElementById('usersBody');
        const currentTableItemCount = usersBodyEl ? usersBodyEl.childElementCount : 0;

        if (currentTableItemCount === 1 && currentUserPage > 1 && allFetchedUsers.length % usersPerPage === 1) { 
            currentUserPage--;
        }
        fetchUsers(); 
    } catch (error) {
        console.error("USERS PAGE: Error deleting user (error likely handled):", error.message);
    }
  }
  
  function getFilteredUsersForExport() {
    let recordsToExport = [...allFetchedUsers]; 
    if (activeUserDateFilter !== 'all') { 
      let range = (activeUserDateFilter === 'custom' && customUserFilterStartDate && customUserFilterEndDate) ? 
                  {startDate:customUserFilterStartDate,endDate:customUserFilterEndDate} : 
                  getDateRange(activeUserDateFilter); 
      if (range.startDate && range.endDate) { 
        recordsToExport = recordsToExport.filter(r => { 
          if (!r.created_at) return false;
          const recordCreationDate = getISODateString(new Date(r.created_at)); 
          return recordCreationDate >= range.startDate && recordCreationDate <= range.endDate; 
        }); 
      } 
    }
    return recordsToExport;
  }

  function exportUsersExcel() {
    const recordsToExport = getFilteredUsersForExport();
    if (recordsToExport.length === 0) {
        alert("No data to export based on current filters.");
        return;
    }
    const wsD = recordsToExport.map(r => ({ 
        ID:r.id, 
        Username:r.username || 'N/A', 
        Email:r.email || 'N/A', 
        Status:r.status ? r.status.replace(/_/g, ' ') : 'N/A', 
        'Created At':r.created_at ? new Date(r.created_at).toLocaleString() : 'N/A'
    }));
    const ws = XLSX.utils.json_to_sheet(wsD); 
    const wb = XLSX.utils.book_new(); 
    XLSX.utils.book_append_sheet(wb, ws, "Users"); 
    XLSX.writeFile(wb, "users_export.xlsx");
  }

  function exportUsersPDF() {
    if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
        console.error("USERS PAGE: jsPDF library is not loaded correctly.");
        alert("PDF export library not loaded. Cannot export PDF.");
        return;
    }
    const {jsPDF} = jspdf; // Correct way to access jsPDF constructor if library is loaded globally
    const doc = new jsPDF(); 
    doc.setFontSize(18); 
    doc.text('User Records', 14, 15);
    
    const recordsToExport = getFilteredUsersForExport();
    if (recordsToExport.length === 0) {
        alert("No data to export based on current filters.");
        return;
    }

    const hdrs = [['ID', 'Username', 'Email', 'Status', 'Created At']];
    const data = recordsToExport.map(r => [
        r.id, 
        r.username || 'N/A', 
        r.email || 'N/A', 
        r.status ? r.status.replace(/_/g, ' ') : 'N/A', 
        r.created_at ? new Date(r.created_at).toLocaleString() : 'N/A'
    ]);
    
    if (typeof doc.autoTable === 'function') {
        doc.autoTable({ 
            head:hdrs, 
            body:data, 
            startY:25, 
            theme:'grid', 
            headStyles:{fillColor:[59,130,246],textColor:255} 
        }); 
    } else {
        console.error("USERS PAGE: jsPDF autoTable plugin is not available. PDF export will be basic.");
        // Basic fallback omitted for brevity but can be added back if needed
    }
    doc.save('users_export.pdf');
  }
  // --- End User Section ---
</script>
</body>
</html>