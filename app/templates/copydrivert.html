<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drivers Management - FleetDash</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> REMOVED -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <style>
    .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
    .modal.hidden { visibility: hidden; opacity: 0; }
    .modal:not(.hidden) { visibility: visible; opacity: 1; }
    .dark .modal-content { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5), 0 10px 10px -5px rgba(0,0,0,0.2); }
    .date-filter-btn.active { background-color: #3b82f6; color: white; } /* For date filters */
    .dark .date-filter-btn.active { background-color: #60a5fa; }      /* For date filters */
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); color: white; display: flex; justify-content: center; align-items: center; z-index: 1000; font-size: 2em; visibility: hidden; }
    .toast {
      transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out, visibility 0.3s ease-in-out;
      visibility: hidden;
      opacity: 0;
      transform: translateX(100%); 
    }
    .toast.show {
      visibility: visible;
      opacity: 1;
      transform: translateX(0);
    }
     .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white">

<!-- Toast Container -->
<div id="toast-container" class="fixed top-5 right-5 z-[100] space-y-2 w-full max-w-xs sm:max-w-sm md:max-w-md">
</div>

<div class="flex flex-col md:flex-row h-screen overflow-hidden">
    <!-- Sidebar (Left) -->
    <aside class="w-64 bg-white dark:bg-gray-800/95 backdrop-blur-sm p-4 space-y-6 shadow-lg hidden md:block flex-shrink-0 border-r dark:border-gray-700">
      <div class="text-2xl font-bold flex items-center space-x-2 text-blue-600 dark:text-blue-400">
        <i data-lucide="command" class="w-7 h-7"></i><span>FleetDash</span>
      </div>
      <nav class="flex-1">
        <ul class="space-y-2">
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i><a href="dashboard.html">Dashboard</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="pie-chart" class="w-5 h-5"></i><a href="analytics.html">Analytics</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="users" class="w-5 h-5"></i><a href="/user/users-page">User</a>
        </li>
        <li class="flex items-center space-x-3 text-blue-600 dark:text-blue-400 font-semibold bg-blue-50 dark:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="user-cog" class="w-5 h-5"></i><a href="/driver/driver-page">Driver</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="car" class="w-5 h-5"></i><a href="/vehicle/vehicle-page">Vehicles</a>
        </li>
         <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="wrench" class="w-5 h-5"></i><a href="/reparation/reparation-page">Reparation</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="alert-triangle" class="w-5 h-5"></i><a href="/panne/panne-page">Pannes</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="droplet" class="w-5 h-5"></i><a href="/fuel/fuel-page">Fuel</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="settings" class="w-5 h-5"></i><a href="/maintenance_category/maintenance-page">Maintenance</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="route" class="w-5 h-5"></i><a href="/trip/trip-page">Trip</a>
        </li>
      </ul>
      </nav>
       <div class="pt-4 border-t border-gray-200 dark:border-gray-700/50 mt-auto">
            <a href="#" id="global-logout-btn" class="flex items-center space-x-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/40 p-2.5 rounded-lg transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i><span>Logout</span>
            </a>
       </div>
    </aside>
    
  <!-- Main content -->
  <main class="flex-1 overflow-auto p-6">
    <!-- Drivers Table Section -->
    <section id="driver-section" class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg mb-6">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
        <div class="flex flex-wrap gap-2 items-center">
          <button onclick="openAddDriverModal()" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-1 text-sm shadow-sm">
            <i data-lucide="user-plus" class="w-4 h-4"></i> Add Driver
          </button>
          <input type="text" id="driverSearch" placeholder="Search (name, email, matricule)..." 
                 class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm text-black dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-auto">
        </div>
        <div class="flex flex-wrap gap-2 items-center">
          <button onclick="exportDriversExcel()" class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 text-sm shadow-sm">ðŸ“„ Excel</button>
          <button onclick="exportDriversPDF()" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm shadow-sm">ðŸ§¾ PDF</button>
        </div>
      </div>

      <div class="mb-4 flex flex-wrap items-center gap-2">
        <span class="text-sm font-medium mr-2 text-gray-700 dark:text-gray-300">Filter Drivers by Creation Date:</span>
        <button id="driver-filter-today" onclick="applyDriverDateFilter('today')" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Today</button>
        <button id="driver-filter-last7" onclick="applyDriverDateFilter('last7days')" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Last 7 Days</button>
        <button id="driver-filter-last30" onclick="applyDriverDateFilter('last30days')" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Last 30 Days</button>
        <button id="driver-filter-all" onclick="applyDriverDateFilter('all')" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 active">All Time</button>
        <button id="driver-filter-custom-btn" onclick="toggleDriverCustomDateRange()" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Custom Range</button>
      </div>
      <div id="driverCustomDateRange" class="mb-4 hidden items-center gap-2 p-3 border dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-800/50">
        <input type="date" id="driverCustomStartDate" class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
        <span class="text-sm text-gray-700 dark:text-gray-300">to</span>
        <input type="date" id="driverCustomEndDate" class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
        <button onclick="applyDriverCustomDateFilter()" class="bg-blue-500 text-white px-3 py-1.5 text-sm rounded-md hover:bg-blue-600">Apply</button>
      </div>

      <div class="overflow-x-auto">
        <table id="driversTable" class="w-full text-left text-sm">
          <thead>
            <tr class="border-b dark:border-gray-700">
              <th class="py-3 px-2 font-semibold">ID</th>
              <th class="px-2 font-semibold">Last Name</th>
              <th class="px-2 font-semibold">First Name</th>
              <th class="px-2 font-semibold">CNI</th>
              <th class="px-2 font-semibold">Email</th>
              <th class="px-2 font-semibold">Matricule</th>
              <th class="px-2 font-semibold">Added On</th>
              <th class="px-2 font-semibold text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="driversBody"></tbody>
        </table>
      </div>
      <div class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
        <div class="text-sm text-gray-600 dark:text-gray-400" id="driversCount"></div>
        <div class="flex items-center space-x-1" id="driversPagination"></div>
      </div>
    </section>
  </main>

    <!-- Right Sidebar -->
    <aside class="w-1/5 bg-white dark:bg-gray-800 p-4 space-y-6 shadow-lg hidden lg:block flex-shrink-0 border-r dark:border-gray-700">
        <div class="flex justify-between items-center">
            <button id="theme-toggle-main" class="text-xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                <!-- Icon will be set by JS -->
            </button>
            <div>
                <div class="text-sm font-semibold" id="currentUserDisplayUsernameSidebar">User</div>
                <div class="text-xs text-gray-500 dark:text-gray-300" id="currentUserRoleDisplaySidebar">Role</div>
            </div>
        </div>
        <!-- Other static content for right sidebar can go here -->
    </aside>
</div>

<!-- MODALS -->
<!-- Add/Edit Driver Modal -->
<div id="addDriverModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="driverModalTitle">Add New Driver</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400">Fill in the driver details below</p>
        </div>
        <button onclick="closeAddDriverModal()" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <form id="addDriverForm" class="space-y-4">
        <input type="hidden" id="driverId_form"> 
        <div>
          <label for="driver_nom_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Last Name</label>
          <input type="text" id="driver_nom_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="Doe">
        </div>
        <div>
          <label for="driver_prenom_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">First Name</label>
          <input type="text" id="driver_prenom_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="John">
        </div>
        <div>
          <label for="driver_cni_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">CNI Number</label>
          <input type="text" id="driver_cni_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="1234567890AB">
        </div>
        <div>
          <label for="driver_email_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
          <input type="email" id="driver_email_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="driver@example.com">
        </div>
        <div>
          <label for="driver_matricule_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Matricule</label>
          <input type="text" id="driver_matricule_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="DRV001">
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeAddDriverModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
          <button type="submit" id="driverSubmitButton" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
            <i data-lucide="user-plus" class="w-4 h-4"></i> Add Driver
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Confirmation Modal for Driver Deletion -->
<div id="confirmDeleteDriverModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <div><h3 class="text-xl font-bold text-gray-800 dark:text-white">Confirm Deletion</h3><p class="text-sm text-gray-500 dark:text-gray-400">Are you sure you want to delete this driver?</p></div>
        <button onclick="closeConfirmDeleteDriverModal()" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i></button>
      </div>
      <div class="flex justify-end gap-3 pt-4">
        <button onclick="closeConfirmDeleteDriverModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
        <button id="confirmDeleteDriverBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg flex items-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i> Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Generic Success/Confirmation Modal -->
<div id="operationSuccessModal" class="modal fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black bg-opacity-60 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm text-center">
    <div class="p-6 space-y-4">
      <div id="successModalIconContainer" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 dark:bg-green-700/30"></div>
      <h3 id="successModalTitle" class="text-xl font-semibold text-gray-900 dark:text-white">Success!</h3>
      <p id="successModalMessage" class="text-sm text-gray-600 dark:text-gray-400">Operation completed.</p>
      <button id="successModalOkButton" onclick="closeOperationSuccessModalAndRefreshDrivers()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2.5 px-4 rounded-lg">OK</button>
    </div>
  </div>
</div>

<div id="loading-overlay">Loading...</div>

<script>
  // --- Global Variables for Drivers ---
  let allFetchedDrivers = []; 
  const driversPerPage = 10; 
  let currentDriversPage = 1;
  let driverToEditId = null; 
  let driverToDeleteId = null;
  let activeDriverDateFilter = 'all'; // For date filters
  let customDriverFilterStartDate = null; 
  let customDriverFilterEndDate = null;
  
  const DRIVER_API_BASE_URL = "/driver";
  const LOGIN_PAGE_URL = "/login.html";

  console.log("DRIVERS PAGE: Script started.");

  // --- Toast Notification System ---
  const toastContainer = document.getElementById('toast-container');
  function showToast(message, type = 'info', duration = 4000) {
    if (!toastContainer) { alert(message); return; }
    const toast = document.createElement('div');
    toast.className = `toast p-4 rounded-lg shadow-lg flex items-center space-x-3 min-w-[250px] max-w-md break-words`; 
    let iconHtml = '', bgColor = 'bg-blue-500 dark:bg-blue-700', textColor = 'text-white', iconColor = 'text-white';
    switch (type) {
        case 'success': bgColor = 'bg-green-500 dark:bg-green-600'; iconHtml = `<i data-lucide="check-circle" class="w-6 h-6 ${iconColor} flex-shrink-0"></i>`; break;
        case 'error': bgColor = 'bg-red-500 dark:bg-red-600'; iconHtml = `<i data-lucide="x-circle" class="w-6 h-6 ${iconColor} flex-shrink-0"></i>`; break;
        case 'warning': bgColor = 'bg-yellow-400 dark:bg-yellow-500'; textColor = 'text-gray-800 dark:text-gray-900'; iconColor = 'text-gray-800 dark:text-gray-900'; iconHtml = `<i data-lucide="alert-triangle" class="w-6 h-6 ${iconColor} flex-shrink-0"></i>`; break;
        default: iconHtml = `<i data-lucide="info" class="w-6 h-6 ${iconColor} flex-shrink-0"></i>`; break;
    }
    toast.classList.add(bgColor, textColor);
    const messageSpan = document.createElement('span'); messageSpan.className = 'flex-grow text-sm'; messageSpan.textContent = message;
    const closeButton = document.createElement('button'); closeButton.innerHTML = `<i data-lucide="x" class="w-5 h-5 ${iconColor} opacity-70 hover:opacity-100"></i>`; closeButton.className = 'ml-auto p-1 -mr-1 -my-1 rounded-full hover:bg-black/10 focus:outline-none focus:ring-2 focus:ring-white/50 flex-shrink-0'; closeButton.setAttribute('aria-label', 'Close toast');
    closeButton.onclick = () => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 350); };
    if (iconHtml) { const iC = document.createElement('div'); iC.innerHTML = iconHtml; toast.appendChild(iC); }
    toast.appendChild(messageSpan); toast.appendChild(closeButton);
    toastContainer.appendChild(toast); lucide.createIcons(); 
    setTimeout(() => toast.classList.add('show'), 10); 
    if (duration > 0) { setTimeout(() => { if (toast.parentElement) { toast.classList.remove('show'); setTimeout(() => { if (toast.parentElement) toast.remove(); }, 350);}}, duration); }
  }

  // --- Generic Success Modal Functions ---
  const operationSuccessModal = document.getElementById('operationSuccessModal');
  const successModalTitle = document.getElementById('successModalTitle');
  const successModalMessage = document.getElementById('successModalMessage');
  const successModalIconContainer = document.getElementById('successModalIconContainer');

  function showDriverOperationSuccessModal(title, message, iconName = 'check-circle', iconColorClass = 'text-green-600 dark:text-green-400') {
      if (!operationSuccessModal || !successModalTitle || !successModalMessage || !successModalIconContainer) {
          showToast(message, 'success'); fetchDrivers(); return;
      }
      successModalTitle.textContent = title; successModalMessage.textContent = message;
      successModalIconContainer.innerHTML = `<i data-lucide="${iconName}" class="w-8 h-8 ${iconColorClass}"></i>`;
      lucide.createIcons(); 
      closeAddDriverModal(); 
      operationSuccessModal.classList.remove('hidden'); document.body.style.overflow = 'hidden';
  }

  function closeOperationSuccessModalAndRefreshDrivers() {
      if (operationSuccessModal) operationSuccessModal.classList.add('hidden');
      document.body.style.overflow = ''; fetchDrivers(); 
  }

  // --- Authentication & API ---
  function getAuthToken() {
    const token = localStorage.getItem('authToken');
    if (!token) {
      showToast("Authentication token not found. Please log in.", "error", 5000);
      setTimeout(() => { window.location.href = LOGIN_PAGE_URL; }, 1500); 
      throw new Error("Auth token not found, redirecting to login."); 
    }
    return token;
  }

  async function makeApiRequest(url, method = 'GET', body = null) {
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) loadingOverlay.style.visibility = 'visible';
    const headers = { 'Content-Type': 'application/json' }; let token;
    try { token = getAuthToken(); } catch (error) { if (loadingOverlay) loadingOverlay.style.visibility = 'hidden'; throw error; }
    headers['Authorization'] = `Bearer ${token}`;
    const requestConfig = { method: method, headers: headers };
    if (body && (method === 'POST' || method === 'PUT')) requestConfig.body = JSON.stringify(body);
    try {
      const response = await fetch(url, requestConfig);
      const responseText = await response.clone().text();
      console.log(`DRIVERS PAGE: Raw for ${method} ${url} (status ${response.status}):\n${responseText.substring(0, 200)}...`);
      if (loadingOverlay) loadingOverlay.style.visibility = 'hidden';
      if (response.status === 204) return null; 
      const data = await response.json(); 
      if (!response.ok) {
        const errorDetail = data.detail || JSON.stringify(data); 
        if (response.status === 401) {
            showToast(`Auth Error: ${errorDetail}. Redirecting...`, 'error', 5000);
            localStorage.removeItem('authToken'); localStorage.removeItem('username');
            setTimeout(() => { window.location.href = LOGIN_PAGE_URL; }, 1500);
        } else { showToast(`API Error (${response.status}): ${errorDetail}`, 'error'); }
        throw new Error(`API Error: ${errorDetail}`);
      }
      return data;
    } catch (error) { 
      if (loadingOverlay) loadingOverlay.style.visibility = 'hidden';
      console.error(`DRIVERS PAGE: Error in makeApiRequest for ${method} ${url}:`, error);
      if (!error.message.startsWith('API Error:')) {
          if (error instanceof SyntaxError) showToast('Server Error: Invalid response.', 'error');
          else if (error.name !== 'AbortError') showToast(`Request failed: ${error.message}`, 'error');
      }
      throw error; 
    }
  }
  
  // --- DOMContentLoaded ---
  document.addEventListener('DOMContentLoaded', () => {
      console.log("DRIVERS PAGE: DOMContentLoaded event fired.");
      
      const storedUsername = localStorage.getItem('username'); 
      const usernameDisplaySidebar = document.getElementById('currentUserDisplayUsernameSidebar'); 
      const roleDisplaySidebar = document.getElementById('currentUserRoleDisplaySidebar');       

      if (usernameDisplaySidebar) usernameDisplaySidebar.textContent = storedUsername || "User";
      else console.warn("currentUserDisplayUsernameSidebar element not found.");

      if (roleDisplaySidebar) roleDisplaySidebar.textContent = "Admin"; 
      else console.warn("currentUserRoleDisplaySidebar element not found.");
      
      const themeBtnMain = document.getElementById('theme-toggle-main');
      function setThemeIcon(isDark) { 
          if(themeBtnMain) themeBtnMain.innerHTML = `<i data-lucide="${isDark ? 'sun' : 'moon'}" class="w-5 h-5"></i>`; 
          lucide.createIcons(); 
      }
      // Check initial theme preference (e.g., from localStorage or system preference)
      let currentIsDark = localStorage.getItem('theme') === 'dark' || 
                         (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
      if (currentIsDark) document.documentElement.classList.add('dark');
      setThemeIcon(currentIsDark);

      themeBtnMain?.addEventListener('click', () => { 
          currentIsDark = document.documentElement.classList.toggle('dark');
          setThemeIcon(currentIsDark);
          localStorage.setItem('theme', currentIsDark ? 'dark' : 'light');
      });

      try { getAuthToken(); initializeDriverSection(); /* initCharts(); REMOVED */ } 
      catch (error) { console.log("DRIVERS PAGE: Init halted. Error:", error.message); return; }
      
      lucide.createIcons(); 
      document.getElementById('addDriverModal')?.addEventListener('click', e => { if (e.target === e.currentTarget) closeAddDriverModal(); });
      document.getElementById('confirmDeleteDriverModal')?.addEventListener('click', e => { if (e.target === e.currentTarget) closeConfirmDeleteDriverModal(); });
      
      document.getElementById('global-logout-btn')?.addEventListener('click', (e) => {
          e.preventDefault(); localStorage.clear(); 
          showToast("You have been logged out.", "info");
          setTimeout(() => { window.location.href = LOGIN_PAGE_URL; }, 1500);
      });
  });

  // --- Helper Functions (getISODateString, getDateRange - same as users.html) ---
  function getISODateString(date) { 
    if (!(date instanceof Date) || isNaN(date.getTime())) return null;
    return date.toISOString().split('T')[0]; 
  }
  function getDateRange(filterType) {
    const today = new Date(); today.setHours(0,0,0,0); 
    let startDate = new Date(today); let endDate = new Date(today); 
    endDate.setHours(23,59,59,999);
    switch(filterType){ 
      case 'today': break; 
      case 'last7days': startDate.setDate(today.getDate() - 6); break; 
      case 'last30days': startDate.setDate(today.getDate() - 29); break; 
      case 'all': return { startDate: null, endDate: null };
      default: return { startDate: null, endDate: null };
    }
    const isoStartDate = getISODateString(startDate);
    const isoEndDate = getISODateString(endDate);
    return (isoStartDate && isoEndDate) ? { startDate: isoStartDate, endDate: isoEndDate } : { startDate: null, endDate: null };
  }
  // --- End Helper Functions ---


  function initializeDriverSection() {
    fetchDrivers(); 
    // No status dropdown for drivers in this version
    document.getElementById('driverSearch')?.addEventListener('input', () => { currentDriversPage = 1; renderDriversTable(); });
    document.getElementById('addDriverForm')?.addEventListener('submit', handleDriverFormSubmit);
    document.getElementById('confirmDeleteDriverBtn')?.addEventListener('click', confirmDeleteDriver);
    setActiveDriverDateFilterButton('all'); // Initialize date filter button
  }

  async function fetchDrivers() {
    const searchTerm = document.getElementById('driverSearch')?.value.toLowerCase() || ""; // Not used if backend handles search with query param
    let url = `${DRIVER_API_BASE_URL}/?limit=1000`; // Fetch many if client-side filtering is primary
    // If backend search is preferred for performance:
    // if (searchTerm) url += `&search=${encodeURIComponent(searchTerm)}`; // Add search to URL

    try {
        const responseData = await makeApiRequest(url); 
        if (responseData && Array.isArray(responseData)) {
            allFetchedDrivers = responseData.map(driver => ({ ...driver }))
                .sort((a, b) => { // Sort by created_at, newest first
                    const dateA = a.created_at ? new Date(a.created_at) : new Date(0); 
                    const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
                    if (isNaN(dateA.getTime())) return 1; 
                    if (isNaN(dateB.getTime())) return -1;
                    return dateB - dateA; 
                });
        } else {
            allFetchedDrivers = []; 
        }
        currentDriversPage = 1; 
        renderDriversTable();
    } catch (error) {
        allFetchedDrivers = []; 
        renderDriversTable();
    }
  }
  
  // --- Date Filter Functions for Drivers ---
  function applyDriverDateFilter(filterType) {
    activeDriverDateFilter = filterType; 
    customDriverFilterStartDate = null; customDriverFilterEndDate = null;
    document.getElementById('driverCustomDateRange')?.classList.add('hidden');
    setActiveDriverDateFilterButton(`driver-filter-${filterType}`); 
    currentDriversPage = 1; 
    renderDriversTable();
  }
  function toggleDriverCustomDateRange() {
    const el = document.getElementById('driverCustomDateRange');
    el?.classList.toggle('hidden');
    if (!el?.classList.contains('hidden')) setActiveDriverDateFilterButton('driver-filter-custom-btn');
    else if (activeDriverDateFilter === 'custom') applyDriverDateFilter('all'); 
  }
  function applyDriverCustomDateFilter() {
    const sDVal = document.getElementById('driverCustomStartDate')?.value;
    const eDVal = document.getElementById('driverCustomEndDate')?.value;
    if (!sDVal || !eDVal) { showToast("Please select both start and end dates.", 'warning'); return; }
    const sDate = new Date(sDVal), eDate = new Date(eDVal);
    if (isNaN(sDate.getTime()) || isNaN(eDate.getTime())) { showToast("Invalid date format.", 'warning'); return; }
    if (sDate > eDate) { showToast("Start date cannot be after end date.", 'warning'); return; }
    activeDriverDateFilter = 'custom'; 
    customDriverFilterStartDate = getISODateString(sDate); customDriverFilterEndDate = getISODateString(eDate);
    if (!customDriverFilterStartDate || !customDriverFilterEndDate) { showToast("Error processing dates.", 'error'); return; }
    setActiveDriverDateFilterButton('driver-filter-custom-btn'); currentDriversPage = 1; renderDriversTable();
  }
  function setActiveDriverDateFilterButton(filterButtonId) {
    document.querySelectorAll('#driver-section .date-filter-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(filterButtonId)?.classList.add('active');
  }
  // --- End Date Filter Functions for Drivers ---


  function renderDriversTable() {
    if (!Array.isArray(allFetchedDrivers)) allFetchedDrivers = []; 
    let recordsToDisplay = [...allFetchedDrivers]; 

    if (activeDriverDateFilter !== 'all') {
      const range = (activeDriverDateFilter === 'custom' && customDriverFilterStartDate && customDriverFilterEndDate) ? 
                  { startDate: customDriverFilterStartDate, endDate: customDriverFilterEndDate } : 
                  getDateRange(activeDriverDateFilter);
      if (range && range.startDate && range.endDate) { 
        recordsToDisplay = recordsToDisplay.filter(driver => {
          if (!driver || !driver.created_at) return false; 
          try {
            const driverCreationDate = new Date(driver.created_at);
            if (isNaN(driverCreationDate.getTime())) return false;
            const driverCreationDateISO = getISODateString(driverCreationDate); 
            return driverCreationDateISO && driverCreationDateISO >= range.startDate && driverCreationDateISO <= range.endDate;
          } catch { return false; }
        });
      }
    }
    
    const searchTerm = document.getElementById('driverSearch').value.toLowerCase();
    if (searchTerm) {
        recordsToDisplay = recordsToDisplay.filter(driver => 
            (driver.nom && driver.nom.toLowerCase().includes(searchTerm)) || 
            (driver.prenom && driver.prenom.toLowerCase().includes(searchTerm)) ||
            (driver.cni && driver.cni.toLowerCase().includes(searchTerm)) ||
            (driver.email && driver.email.toLowerCase().includes(searchTerm)) ||
            (driver.matricule && driver.matricule.toLowerCase().includes(searchTerm))
        );
    }

    const startIdx = (currentDriversPage - 1) * driversPerPage;
    const paginatedDrivers = recordsToDisplay.slice(startIdx, startIdx + driversPerPage);
    const driversBody = document.getElementById('driversBody');
    if(!driversBody) return;

    driversBody.innerHTML = paginatedDrivers.length > 0 ? 
        paginatedDrivers.map(d => `
            <tr class="border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700/50" data-id="${d.id}">
                <td class="py-3 px-2">${d.id}</td> <td class="px-2">${d.nom}</td> <td class="px-2">${d.prenom}</td>
                <td class="px-2">${d.cni}</td> <td class="px-2">${d.email}</td> <td class="px-2">${d.matricule}</td>
                <td class="px-2">${new Date(d.created_at).toLocaleDateString()}</td>
                <td class="px-2 text-center whitespace-nowrap">
                    <button onclick="openEditDriverModal(${d.id})" class="text-blue-600 dark:text-blue-400 p-1" title="Edit Driver"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                    <button onclick="openConfirmDeleteDriverModal(${d.id})" class="text-red-600 dark:text-red-400 p-1 ml-1" title="Delete Driver"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td></tr>`).join('') 
        : `<tr><td colspan="8" class="text-center py-8 text-gray-500">No drivers found matching criteria.</td></tr>`;
    lucide.createIcons();
    document.getElementById('driversCount').textContent = `Showing ${paginatedDrivers.length > 0 ? startIdx + 1 : 0} to ${Math.min(startIdx + paginatedDrivers.length, recordsToDisplay.length)} of ${recordsToDisplay.length} drivers`;
    renderDriversPagination(recordsToDisplay.length);
  }

  function renderDriversPagination(totalRecords) {
    const totalPages = Math.ceil(totalRecords / driversPerPage);
    const paginationContainer = document.getElementById('driversPagination');
    if (!paginationContainer) { console.warn("driversPagination element not found."); return; }
    paginationContainer.innerHTML = ''; 
    if (totalPages <= 1) return; 

    const btnBaseClasses = "flex items-center justify-center px-3 h-8 text-sm font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-1 dark:focus:ring-offset-gray-900 focus:ring-blue-500 transition-colors duration-150";
    const btnPageClasses = `${btnBaseClasses} leading-tight`;
    const btnArrowClasses = `${btnBaseClasses}`;
    const inactiveClasses = "text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white";
    const activeClasses = "text-blue-600 border border-blue-300 bg-blue-50 hover:bg-blue-100 hover:text-blue-700 dark:border-gray-700 dark:bg-gray-700 dark:text-white";
    const disabledClasses = "text-gray-400 bg-gray-100 border border-gray-200 cursor-not-allowed dark:bg-gray-700/50 dark:border-gray-600 dark:text-gray-500";

    const createButton = (content, pageToGo, isEnabled, isCurrentPage = false, isArrow = false) => {
        const button = document.createElement('button');
        if (typeof content === 'string' && content.startsWith('<')) { button.innerHTML = content; } 
        else { button.textContent = content; }
        let specificClasses = isCurrentPage ? activeClasses : (isEnabled ? inactiveClasses : disabledClasses);
        button.className = `${isArrow ? btnArrowClasses : btnPageClasses} ${specificClasses}`;
        if (isEnabled && !isCurrentPage) { button.onclick = () => { currentDriversPage = pageToGo; renderDriversTable(); }; } 
        else if (!isEnabled) { button.disabled = true; button.setAttribute('aria-disabled', 'true'); }
        if(isCurrentPage) button.setAttribute('aria-current', 'page');
        return button;
    };
    const createEllipsis = () => { const el = document.createElement('span'); el.textContent = '...'; el.className = "flex items-center justify-center px-3 h-8 leading-tight text-gray-500 dark:text-gray-400"; return el; };

    paginationContainer.appendChild(createButton(`<span class="sr-only">Previous</span><i data-lucide="chevron-left" class="w-4 h-4"></i>`, currentDriversPage - 1, currentDriversPage > 1, false, true));
    const SIBLING_COUNT = 1; 
    if (totalPages > 1) { 
        if (currentDriversPage !== 1 && totalPages > 0) paginationContainer.appendChild(createButton("1", 1, true, false));
        else if (totalPages > 0) paginationContainer.appendChild(createButton("1", 1, true, true));

        if (currentDriversPage > SIBLING_COUNT + 2 && totalPages > SIBLING_COUNT * 2 + 2) { // Adjusted threshold for ellipsis
             if ( (currentDriversPage - SIBLING_COUNT) > 2) paginationContainer.appendChild(createEllipsis());
        }

        const startPageLoop = Math.max(2, currentDriversPage - SIBLING_COUNT);
        const endPageLoop = Math.min(totalPages - 1, currentDriversPage + SIBLING_COUNT);
        for (let i = startPageLoop; i <= endPageLoop; i++) {
            if (i !== 1 && i !== totalPages) { // Avoid duplicating 1 and last page if they fall in this loop
                 paginationContainer.appendChild(createButton(String(i), i, true, currentDriversPage === i));
            }
        }
        if (currentDriversPage < totalPages - (SIBLING_COUNT + 1) && totalPages > SIBLING_COUNT * 2 + 2 ) { // Adjusted threshold
             if ( (currentDriversPage + SIBLING_COUNT) < totalPages -1 ) paginationContainer.appendChild(createEllipsis());
        }
        if (totalPages > 1 && currentDriversPage !== totalPages) paginationContainer.appendChild(createButton(String(totalPages), totalPages, true, false));
        else if (totalPages > 1 && currentDriversPage === totalPages && totalPages !== 1 ) {
            // If current page is last page, ensure it's marked active
            // This condition might need to be combined if last page is already added by loop
            let lastPageAlreadyActive = false;
            paginationContainer.childNodes.forEach(node => {
                if(node.tagName === 'BUTTON' && parseInt(node.textContent) === totalPages && node.classList.contains(activeClasses.split(" ")[0])) {
                    lastPageAlreadyActive = true;
                }
            });
            if(!lastPageAlreadyActive) { // Only add if not already added as active
                 const existingLast = Array.from(paginationContainer.children).find(c => c.textContent == totalPages);
                 if(existingLast) existingLast.remove(); // remove non-active if it exists
                 paginationContainer.appendChild(createButton(String(totalPages), totalPages, true, true));
            }
        }
    }
    paginationContainer.appendChild(createButton(`<span class="sr-only">Next</span><i data-lucide="chevron-right" class="w-4 h-4"></i>`, currentDriversPage + 1, currentDriversPage < totalPages, false, true));
    lucide.createIcons();
  }
  
  // --- Modal Functions for Driver ---
  function openAddDriverModal() {
    driverToEditId = null; document.getElementById('addDriverForm')?.reset();
    document.getElementById('driverModalTitle').textContent = "Add New Driver";
    document.getElementById('driverSubmitButton').innerHTML = `<i data-lucide="user-plus" class="w-4 h-4"></i> Add Driver`;
    lucide.createIcons(); 
    document.getElementById('addDriverModal')?.classList.remove('hidden'); document.body.style.overflow='hidden';
  }

  function openEditDriverModal(id) {
    if (id==null) { showToast("Invalid driver ID for edit.", "warning"); return; }
    const driver = allFetchedDrivers.find(d => d.id === id); 
    if (!driver) { showToast("Driver not found for editing.", "warning"); return; }
    driverToEditId=id; document.getElementById('addDriverForm')?.reset();
    document.getElementById('driverModalTitle').textContent = "Edit Driver";
    document.getElementById('driverSubmitButton').innerHTML = `<i data-lucide="save" class="w-4 h-4"></i> Save Changes`;
    document.getElementById('driverId_form').value = driver.id; 
    document.getElementById('driver_nom_form').value = driver.nom||'';
    document.getElementById('driver_prenom_form').value = driver.prenom||'';
    document.getElementById('driver_cni_form').value = driver.cni||'';
    document.getElementById('driver_email_form').value = driver.email||'';
    document.getElementById('driver_matricule_form').value = driver.matricule||'';
    lucide.createIcons(); document.getElementById('addDriverModal')?.classList.remove('hidden'); document.body.style.overflow='hidden';
  }

  function closeAddDriverModal() { 
    document.getElementById('addDriverModal')?.classList.add('hidden'); document.body.style.overflow=''; 
    driverToEditId=null; 
  }

  async function handleDriverFormSubmit(event) {
    event.preventDefault();
    const driverData = {
      nom: document.getElementById('driver_nom_form').value,
      prenom: document.getElementById('driver_prenom_form').value,
      cni: document.getElementById('driver_cni_form').value,
      email: document.getElementById('driver_email_form').value,
      matricule: document.getElementById('driver_matricule_form').value,
    };
    if (!driverData.nom || !driverData.prenom || !driverData.cni || !driverData.email || !driverData.matricule) {
      showToast("Please fill all required driver fields.", "warning"); return;
    }
    try {
        let successTitle = '', successMessage = '';
        if (driverToEditId) {
            await makeApiRequest(`${DRIVER_API_BASE_URL}/${driverToEditId}`, 'PUT', driverData);
            successTitle = 'Driver Updated!'; successMessage = 'Driver record updated successfully.';
        } else {
            await makeApiRequest(`${DRIVER_API_BASE_URL}/`, 'POST', driverData);
            successTitle = 'Driver Added!'; successMessage = 'New driver added successfully.';
        }
        closeAddDriverModal(); 
        showDriverOperationSuccessModal(successTitle, successMessage);
    } catch (error) { /* Error toast handled by makeApiRequest */ }
  }

  function openConfirmDeleteDriverModal(id) { 
    if (id == null) return; 
    driverToDeleteId = id; 
    document.getElementById('confirmDeleteDriverModal')?.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }
  function closeConfirmDeleteDriverModal() { 
    driverToDeleteId = null; 
    document.getElementById('confirmDeleteDriverModal')?.classList.add('hidden');
    document.body.style.overflow = '';
  }
  
  async function confirmDeleteDriver() {
    if (driverToDeleteId == null) return;
    try {
        await makeApiRequest(`${DRIVER_API_BASE_URL}/${driverToDeleteId}`, 'DELETE');
        closeConfirmDeleteDriverModal(); 
        showDriverOperationSuccessModal('Driver Deleted!', 'Driver record deleted successfully.', 'trash-2', 'text-red-600 dark:text-red-400');
        allFetchedDrivers = allFetchedDrivers.filter(d => d.id !== driverToDeleteId); 
        const totalPages = Math.ceil(allFetchedDrivers.length / driversPerPage);
        if (currentDriversPage > totalPages && totalPages > 0) currentDriversPage = totalPages;
        else if (allFetchedDrivers.length === 0) currentDriversPage = 1;
        driverToDeleteId = null;
    } catch (error) { /* Error toast handled by makeApiRequest */ }
  }
  
  // --- Export Functions ---
  function getFilteredDriversForExport() {
    let recordsToExport = [...allFetchedDrivers];
    if (activeDriverDateFilter !== 'all') {
      const range = (activeDriverDateFilter === 'custom' && customDriverFilterStartDate && customDriverFilterEndDate) ? 
                  {startDate:customDriverFilterStartDate,endDate:customDriverFilterEndDate} : 
                  getDateRange(activeDriverDateFilter); 
      if (range && range.startDate && range.endDate) { 
        recordsToExport = recordsToExport.filter(r => { 
          if (!r || !r.created_at) return false;
          try {
            const d = new Date(r.created_at); if (isNaN(d.getTime())) return false;
            const iso = getISODateString(d); return iso && iso >= range.startDate && iso <= range.endDate; 
          } catch { return false; }
        }); 
      } 
    }
    const searchTerm = document.getElementById('driverSearch').value.toLowerCase();
    if (searchTerm) {
        recordsToExport = recordsToExport.filter(driver => 
            (driver.nom && driver.nom.toLowerCase().includes(searchTerm)) || 
            (driver.prenom && driver.prenom.toLowerCase().includes(searchTerm)) ||
            (driver.cni && driver.cni.toLowerCase().includes(searchTerm)) ||
            (driver.email && driver.email.toLowerCase().includes(searchTerm)) ||
            (driver.matricule && driver.matricule.toLowerCase().includes(searchTerm))
        );
    }
    return recordsToExport;
  }

  function exportDriversExcel() {
    const drivers = getFilteredDriversForExport(); if(drivers.length===0){showToast("No drivers to export.","info");return;}
    const data = drivers.map(d=>({ ID:d.id, 'Last Name':d.nom, 'First Name':d.prenom, CNI:d.cni, Email:d.email, Matricule:d.matricule, 'Added On':new Date(d.created_at).toLocaleString() }));
    const ws=XLSX.utils.json_to_sheet(data); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Drivers"); XLSX.writeFile(wb,"drivers_export.xlsx");
  }
  function exportDriversPDF() {
    if(typeof jspdf==='undefined'||!jspdf.jsPDF){showToast("PDF library not loaded.","error");return;}
    const{jsPDF}=jspdf; const doc=new jsPDF(); doc.setFontSize(18); doc.text('Driver Records',14,15);
    const drivers=getFilteredDriversForExport(); if(drivers.length===0){showToast("No drivers to export.","info");return;}
    const h=[['ID','Last Name','First Name','CNI','Email','Matricule','Added On']];
    const d=drivers.map(dr=>[dr.id,dr.nom,dr.prenom,dr.cni,dr.email,dr.matricule,new Date(dr.created_at).toLocaleString()]);
    if(typeof doc.autoTable==='function'){doc.autoTable({head:h,body:d,startY:25,theme:'grid',headStyles:{fillColor:[59,130,246],textColor:255}});}
    else{showToast("PDF autoTable not found.","error");}
    doc.save('drivers_export.pdf');
  }

  // function initCharts() { /* REMOVED */ }

</script>
</body>
</html>